<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<!-- 20180426-->
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="SpringMVC,Spring,Spring boot," />










<meta name="description" content="单节内容第一节开发工具和Java语言介绍主要介绍项目所需要的开发工具，并且会简单回顾这个项目所用到的语言-java，语法基础，控制流，数据结构，面向对象，异常，随机数等。">
<meta name="keywords" content="SpringMVC,Spring,Spring boot">
<meta property="og:type" content="article">
<meta property="og:title" content="项目学习总结">
<meta property="og:url" content="http://yoursite.com/2018/07/31/项目学习总结/index.html">
<meta property="og:site_name" content="Xudong&#39;s blogs">
<meta property="og:description" content="单节内容第一节开发工具和Java语言介绍主要介绍项目所需要的开发工具，并且会简单回顾这个项目所用到的语言-java，语法基础，控制流，数据结构，面向对象，异常，随机数等。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/54778394.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/16445716.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-27/36974425.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/54902062.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-25/45752559.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-25/86026975.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/18868142.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/78863910.jpg">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/11861611-46328f0891f5eda3?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/69983327.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/20611245.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/48084756.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/63511127.jpg">
<meta property="og:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/18689521.jpg">
<meta property="og:updated_time" content="2018-08-06T11:14:22.938Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="项目学习总结">
<meta name="twitter:description" content="单节内容第一节开发工具和Java语言介绍主要介绍项目所需要的开发工具，并且会简单回顾这个项目所用到的语言-java，语法基础，控制流，数据结构，面向对象，异常，随机数等。">
<meta name="twitter:image" content="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/54778394.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/07/31/项目学习总结/"/>





  <title>项目学习总结 | Xudong's blogs</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xudong's blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">email:2228998096@qq.com    wechat:yxd19940114</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/31/项目学习总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="杨旭东">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xudong's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">项目学习总结</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-31T19:15:32+08:00">
                2018-07-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="单节内容"><a href="#单节内容" class="headerlink" title="单节内容"></a>单节内容</h1><p>第一节<br>开发工具和Java语言介绍<br>主要介绍项目所需要的开发工具，并且会简单回顾这个项目所用到的语言-java，语法基础，控制流，数据结构，面向对象，异常，随机数等。</p>
<a id="more"></a>
<p>第二节<br>Spring入门，模板语法和渲染<br>主要结合Spring进行入门介绍，包括参数解析，HTTP Method，AOP等等。<br>第三节<br>数据库交互MyBatis集成<br>主要对业务的字段进行设计，数据库的创建，数据库的交互等，并会介绍注解和XML定义以及首页的开发。<br>第四节<br>用户注册登录管理<br>主要实现注册，登录，浏览等基本功能，并且会考虑到数据安全性等。<br>第五节<br>资讯发布，图片上传，资讯首页<br>主要实现资讯的发布，图片的上传，完成资讯首页的搭建。<br>第六节<br>评论中心，站内信<br>主要搭建资讯详情页，实现评论，站内信等功能。<br>第七节<br>redis入门以及redis实现赞踩功能<br>主要讲解Redis，带你入门以及redis实现赞踩功能。<br>第八节<br>异步设计和站内邮件通知系统<br>主要进行异步涉及和搭建站内邮件通知系统，实现邮件的发送功能。<br>第九节<br>多种资讯排序算法 2<br>主要讲述多种资讯排序算法以及多线程的讲解。<br>第十节<br>JavaWeb项目测试和部署，课程总结回顾<br>主要进行整个项目的测试以及打包，部署，并且会对整个项目进行一个总结和扩展，讲述面试中怎样讲解项目以及包装。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/54778394.jpg" alt="结构"></p>
<h1 id="1-aspect"><a href="#1-aspect" class="headerlink" title="1. aspect"></a>1. aspect</h1><h2 id="1-1-LogAspect"><a href="#1-1-LogAspect" class="headerlink" title="1.1 LogAspect"></a>1.1 LogAspect</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAspect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(LogAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"execution(* com.nowcoder.controller.*Controller.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeMethod</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (Object arg : joinPoint.getArgs()) &#123;</span><br><span class="line">            sb.append(<span class="string">"arg:"</span> + arg.toString() + <span class="string">"|"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">"before method: "</span> + sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"execution(* com.nowcoder.controller.IndexController.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterMethod</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"after method: "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-Component"><a href="#1-Component" class="headerlink" title="1) @Component"></a>1) @Component</h3><p>使用<code>@Component</code><strong>标记</strong>为IOC容器中的组件</p>
<h3 id="2-Logger-LOG-LoggerFactory-getLogger"><a href="#2-Logger-LOG-LoggerFactory-getLogger" class="headerlink" title="2) Logger LOG = LoggerFactory.getLogger()"></a>2) <code>Logger LOG = LoggerFactory.getLogger()</code></h3><p>用Logger工厂<strong>获取</strong>Logger实例</p>
<h3 id="3-JoinPoint-对象"><a href="#3-JoinPoint-对象" class="headerlink" title="3) JoinPoint 对象"></a>3) JoinPoint 对象</h3><p>JoinPoint对象封装了SpringAop中切面方法的信息,在切面方法中添加JoinPoint参数,就可以获取到封装了该方法信息的JoinPoint对象.<br>常用api:</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>Signature getSignature()</td>
<td>获取封装了署名信息的对象,在该对象中可以获取到目标方法名,所属类的Class等信息</td>
</tr>
<tr>
<td>Object[] getArgs()</td>
<td>获取传入目标方法的参数对象</td>
</tr>
<tr>
<td>Object getTarget()</td>
<td>获取被代理的对象</td>
</tr>
<tr>
<td>Object getThis()</td>
<td>获取代理对象</td>
</tr>
</tbody>
</table>
<h1 id="2-async"><a href="#2-async" class="headerlink" title="2. async"></a>2. async</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/16445716.jpg" alt="async"></p>
<h3 id="异步点赞"><a href="#异步点赞" class="headerlink" title="异步点赞"></a>异步点赞</h3><h4 id="为什么异步"><a href="#为什么异步" class="headerlink" title="为什么异步"></a>为什么异步</h4><p>点赞，回复评论的时候，表面上是赞数增加了，其实还有很多其他的工作要做。比如，对方要收到消息提醒，成就值增加。<strong>一些行为会引起一系列连锁反应</strong>。如果在点赞时立马处理，会影响程序运行效率。而且会造成代码冗余，比如发布新闻，和回复评论都可以使得成就值增加，如果都跟着写在后面的代码里会把成就值增加这段代码写两遍，所以大型服务需要服务化和异步化。 </p>
<ul>
<li>服务化<br>服务化：某一个单独的业务独立成一个工程，提供接口。不只是service层的一个类。<br>暴露一些接口，比如数据库服务，如果一个部门要去数据库查询，小公司可能写个SQL语句。对于大公司，需要一个组单独做数据库服务，暴露接口给别的部门用。好处是防止别的部门有数据库权限，数据库单独有一个组维护，出问题找他们运维就好。</li>
<li>异步化<br>异步化：用户点赞，用户首先要知道的是这个赞已经点上了。用户提交Oj，用户要立马知道的是代码有没有通过。而<strong>后面应该的东西，比如积分增加了，用户不会有立马想知道的需求，如果间隔几秒钟在更新，用户也不会有很大的意见。</strong> </li>
</ul>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在一个网站中，一个业务发生的同时，还有一些后续业务需要发生。</p>
<p>比如点赞，除了完成点赞功能外，还有一系列，比如提醒被点赞的用户等等，为了能够实现这些操作并且不拖慢单纯点赞功能的实现，我们将这些使用异步队列实现。</p>
<p>处理流程如下图：</p>
<p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-27/36974425.jpg" alt="处理流程"></p>
<ul>
<li>Biz(生产)<br>Biz为<code>业务</code>部门，理解为点赞的实现，也就是在实现点赞的同时通过EventProducer发送一个事件</li>
<li>进入队列<br>这个事件进入队列等待，队列另一头，有一个EventConsumer，不断消费事件</li>
<li>EventHandler(消费)<br>EventConsumer下面有很多EventHandler，只要EventHandler发现自己需要处理的事件类型，就会进行相应的操作。</li>
</ul>
<p>优点：①后续业务的实现，不会拖慢主业务。②如果后续业务的服务器挂掉，只要重启，继续从优先队列消费事件即可。</p>
<h2 id="2-1-LikeHandler"><a href="#2-1-LikeHandler" class="headerlink" title="2.1 LikeHandler"></a>2.1 LikeHandler</h2><p>记得开启Rrdis—<code>redis-server.exe redis.windows.conf</code></p>
<p>具体的执行动作，具体的实现类，这个是点赞后要执行的行为，给别人发提醒。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LikeHandler</span> <span class="keyword">implements</span> <span class="title">EventHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHandle</span><span class="params">(EventModel model)</span> </span>&#123;</span><br><span class="line">        Message message = <span class="keyword">new</span> Message();</span><br><span class="line">        message.setFromId(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//message.setToId(model.getEntityOwnerId());</span></span><br><span class="line">        message.setToId(model.getActorId());</span><br><span class="line">        User user = userService.getUser(model.getActorId());</span><br><span class="line">        message.setContent(<span class="string">"用户"</span> + user.getName()</span><br><span class="line">                + <span class="string">"赞了你的资讯,http://127.0.0.1:8080/news/"</span> + model.getEntityId());</span><br><span class="line">        message.setCreatedDate(<span class="keyword">new</span> Date());</span><br><span class="line">        messageService.addMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;EventType&gt; <span class="title">getSupportEventTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(EventType.LIKE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-参考-Spring-Autowired注解与自动装"><a href="#1-参考-Spring-Autowired注解与自动装" class="headerlink" title="1)参考 Spring@Autowired注解与自动装"></a>1)参考 <a href="https://blog.csdn.net/HEYUTAO007/article/details/5981555" target="_blank" rel="noopener">Spring@Autowired注解与自动装</a></h3><p>Spring 2.5 引入了 @Autowired 注释，它可以对类成员变量、方法及构造函数进行标注，完成自动装配的工作。 通过 @Autowired的使用来消除 set ，get方法。</p>
<ol>
<li>事先在 Spring 容器中声明<br>Spring 通过一个 BeanPostProcessor 对 @Autowired 进行解析，所以要让 @Autowired 起作用必须事先在 Spring 容器中声明 <code>AutowiredAnnotationBeanPostProcessor</code> Bean。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 该 BeanPostProcessor 将自动对标注 @Autowired 的 Bean 进行注入 --&gt;</span>     </span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>修改在原来注入spirng容器中的bean的方法<br>修改在原来注入spirng容器中的bean的方法：在域变量上加上标签@Autowired,并且去掉 相应的get 和set方法</p>
</li>
<li><p><porpery>也去掉<br>在applicatonContext.xml中 把原来 引用的<porpery>标签也去掉。</porpery></porpery></p>
</li>
</ol>
<h2 id="2-2-LoginExceptionHandler"><a href="#2-2-LoginExceptionHandler" class="headerlink" title="2.2 LoginExceptionHandler"></a>2.2 LoginExceptionHandler</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginExceptionHandler</span> <span class="keyword">implements</span> <span class="title">EventHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MailSender mailSender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doHandle</span><span class="params">(EventModel model)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是否有异常登陆</span></span><br><span class="line">        Message message = <span class="keyword">new</span> Message();</span><br><span class="line">        message.setToId(model.getActorId());</span><br><span class="line">        message.setContent(<span class="string">"你上次的登陆ip异常"</span>);</span><br><span class="line">        message.setFromId(<span class="number">3</span>);</span><br><span class="line">        message.setCreatedDate(<span class="keyword">new</span> Date());</span><br><span class="line">        messageService.addMessage(message);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        map.put(<span class="string">"username"</span>, model.getExt(<span class="string">"username"</span>));</span><br><span class="line">        mailSender.sendWithHTMLTemplate(model.getExt(<span class="string">"email"</span>), <span class="string">"登陆异常"</span>, <span class="string">"mails/welcome.html"</span>,</span><br><span class="line">                map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;EventType&gt; <span class="title">getSupportEventTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(EventType.LOGIN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-EventConsumer"><a href="#2-3-EventConsumer" class="headerlink" title="2.3 EventConsumer"></a>2.3 EventConsumer</h2><h3 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h3><p>如何将活动分发下去给相关的所有handle实现。</p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>消费活动，在初始化前，<strong>先得到Handler接口所有的实现类</strong>，遍历实现类。<br>通过getSupportEventType得到<strong>每个实现类对应处理的活动类型</strong>。反过来记录在config哈希表中，config中的key是活动的类型，比如说是LIKE，COMMENT，是枚举里的成员，value是一个ArrayList的数组，里面存放的是各种实现方法。见代码中的。当从队列中获得一个活动时，这里用的是从右向外pop()一个活动实体。进行解析。这里的config.get(eventModel.getType())是一个数组，里面存放着所有关于这个活动要执行的实现类。遍历这个数组，开始执行实现类里的方法。</p>
<h3 id="一些注释"><a href="#一些注释" class="headerlink" title="一些注释"></a>一些注释</h3><ol>
<li><code>implements InitializingBean</code> , <code>@Override
afterPropertiesSet()</code><br>InitializingBean  通过实现此接口的afterPropertiesSet()方法记录哪<strong>些Event需要哪些handler来处理</strong></li>
<li><code>implements ApplicationContextAware</code><br>ApplicationContextAware  通过实现此接口的setApplicationContext方法<strong>获取上下文</strong></li>
<li><code>Map&lt;EventType, List&lt;EventHandler&gt;&gt; config = new HashMap&lt;&gt;();</code><br>用来存储一个事件类型对应的所有的eventhandler，下次有<strong>该事件</strong>产生时，即可直接调用对应的list</li>
<li><code>Map&lt;String, EventHandler&gt; beans = applicationContext.getBeansOfType(EventHandler.class);</code><br>找出上下文中所有实现了EventHandler接口的类，存入beans</li>
<li><code>if (beans != null)……</code><br>遍历所有的handler，将他们存入他们所监听的eventType对应的list中</li>
<li><code>List&lt;String&gt; messages = jedisAdapter.brpop(0, key);</code><br>从redis的队列中取出事件，并存入list中</li>
<li><code>for (String message : messages)</code><br>遍历取出的事件<br>7.1 <code>if (message.equals(key))</code><br>第一个元素是队列名字，跳过<br>7.2 <code>if (!config.containsKey(eventModel.getType()))</code><br>跳过不能处理的事件<br>7.3 <code>for (EventHandler handler : config.get(eventModel.getType()))</code><br>处理他的所有的handler</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">//1------------------------</span><br><span class="line">public class EventConsumer implements InitializingBean, ApplicationContextAware &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger logger = LoggerFactory.getLogger(EventConsumer.class);</span><br><span class="line">    //2--------------</span><br><span class="line">    private Map&lt;EventType, List&lt;EventHandler&gt;&gt; config = new HashMap&lt;&gt;();</span><br><span class="line">    private ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JedisAdapter jedisAdapter;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">        //4----------------------</span><br><span class="line">        Map&lt;String, EventHandler&gt; beans = applicationContext.getBeansOfType(EventHandler.class);</span><br><span class="line">        //5-----------------------------</span><br><span class="line">        if (beans != null) &#123;</span><br><span class="line">            for (Map.Entry&lt;String, EventHandler&gt; entry : beans.entrySet()) &#123;</span><br><span class="line">                List&lt;EventType&gt; eventTypes = entry.getValue().getSupportEventTypes();//查看事件的监视事件</span><br><span class="line">                for (EventType type : eventTypes) &#123;</span><br><span class="line">                    if (!config.containsKey(type)) &#123;</span><br><span class="line">                        config.put(type, new ArrayList&lt;EventHandler&gt;());</span><br><span class="line">                        System.out.println(&quot;添加一个新的 ：&quot; + type);//20180802</span><br><span class="line">                    &#125;</span><br><span class="line">                    config.get(type).add(entry.getValue());// 注册每个事件的处理函数</span><br><span class="line">                    System.out.println(&quot;注册每个事件的处理函数 ：&quot; + type + &quot; &quot; + entry.getValue()); //20180802</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread thread = new Thread(new Runnable() &#123;// 启动线程去消费事件</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                while (true) &#123;// 从队列一直消费</span><br><span class="line">                    String key = RedisKeyUtil.getEventQueueKey();</span><br><span class="line">                    //6------------------------------</span><br><span class="line">                    List&lt;String&gt; messages = jedisAdapter.brpop(0, key);</span><br><span class="line">                    </span><br><span class="line">                    for (String message : messages) &#123;</span><br><span class="line">                        //7.1---------------</span><br><span class="line">                        if (message.equals(key)) &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        EventModel eventModel = JSON.parseObject(message, EventModel.class);</span><br><span class="line">                        //7.2---------------</span><br><span class="line">                        System.out.println(&quot;找到这个事件的处理handler列表 : &quot; + eventModel.getType()) //20180802</span><br><span class="line">                        if (!config.containsKey(eventModel.getType())) &#123; //找到这个事件的处理handler列表</span><br><span class="line">                            logger.error(&quot;不能识别的事件&quot;);</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //7.3---------------</span><br><span class="line">                        for (EventHandler handler : config.get(eventModel.getType())) &#123;//处理他的所有的handler</span><br><span class="line">                            System.out.println(&quot;处理事件 ： &quot; + eventModel.getType() + &quot; &quot; + handler.getClass() );//20180802</span><br><span class="line">                            handler.doHandle(eventModel);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123;</span><br><span class="line">        this.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-EventHandler"><a href="#2-4-EventHandler" class="headerlink" title="2.4 EventHandler"></a>2.4 EventHandler</h2><p>设计为一个接口，handler都实现此接口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface EventHandler &#123;</span><br><span class="line">    void doHandle(EventModel model);//处理此事件</span><br><span class="line">    List&lt;EventType&gt; getSupportEventTypes();//添加监视的事件类型</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-EventModel"><a href="#2-5-EventModel" class="headerlink" title="2.5 EventModel"></a>2.5 EventModel</h2><p>即发送的队列的事件模型，只有一些基本属性和get、set方法。</p>
<p>其中一些set的return 设置为this，是因为方便连续set多个属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> EventType type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> actorId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> entityType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> entityId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> entityOwnerId;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; exts = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventModel</span><span class="params">(EventType type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventModel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getExt</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exts.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventModel <span class="title">setExt</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        exts.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;<span class="comment">//方便连续set多个属性。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventType <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventModel <span class="title">setType</span><span class="params">(EventType type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getActorId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> actorId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventModel <span class="title">setActorId</span><span class="params">(<span class="keyword">int</span> actorId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.actorId = actorId;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getEntityType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> entityType;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventModel <span class="title">setEntityType</span><span class="params">(<span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.entityType = entityType;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getEntityId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> entityId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventModel <span class="title">setEntityId</span><span class="params">(<span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.entityId = entityId;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getEntityOwnerId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> entityOwnerId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventModel <span class="title">setEntityOwnerId</span><span class="params">(<span class="keyword">int</span> entityOwnerId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.entityOwnerId = entityOwnerId;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getExts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exts;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExts</span><span class="params">(Map&lt;String, String&gt; exts)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exts = exts;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-EventProducer"><a href="#2-6-EventProducer" class="headerlink" title="2.6 EventProducer"></a>2.6 EventProducer</h2><p>活动生产者，相当于生产消费者中的生产者，在controller层执行一个动作后，用这个类把需要异步的信息打包好，放进Redis的队列中。放入是把EventModel<strong>序列化为JSON</strong>，存入Redis的列表中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventProducer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JedisAdapter jedisAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fireEvent</span><span class="params">(EventModel model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String json = JSONObject.toJSONString(model);</span><br><span class="line">            String key = RedisKeyUtil.getEventQueueKey();</span><br><span class="line">            jedisAdapter.lpush(key, json);</span><br><span class="line">            System.out.println(<span class="string">"产生一个异步事件："</span> + eventModel.getType());<span class="comment">//20180802</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-JSON"><a href="#1-JSON" class="headerlink" title="1) JSON"></a>1) JSON</h3><p>由于 JSON 语法是 JavaScript 语法的子集，JavaScript 函数 eval() 可用于将 JSON 文本转换为 JavaScript 对象。 </p>
<h4 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h4><ul>
<li><code>JSON(JavaScript Object Notation)</code>是一种轻量级的数据交换格式。 </li>
<li>JSON 是存储和交换文本信息的语法。类似 XML。 </li>
<li>JSON 比 XML 更小、更快，更易解析。</li>
</ul>
<h4 id="为什么使用-JSON？"><a href="#为什么使用-JSON？" class="headerlink" title="为什么使用 JSON？"></a>为什么使用 JSON？</h4><blockquote>
<p>对于 AJAX 应用程序来说，JSON 比 XML 更快更易使用：</p>
</blockquote>
<h5 id="使用-XML"><a href="#使用-XML" class="headerlink" title="使用 XML"></a>使用 XML</h5><ul>
<li>读取 XML 文档</li>
<li>使用 XML DOM 来循环遍历文档</li>
<li>读取值并存储在变量中</li>
</ul>
<h5 id="使用-JSON"><a href="#使用-JSON" class="headerlink" title="使用 JSON"></a>使用 JSON</h5><ul>
<li>读取 JSON 字符串</li>
<li>用 <code>eval()</code> 处理 JSON 字符串</li>
</ul>
<h4 id="书写格式"><a href="#书写格式" class="headerlink" title="书写格式"></a>书写格式</h4><p>JSON 数据的书写格式是：名称/值对。<br>名称/值对包括字段名称（在双引号中），后面写一个冒号，然后是值：<br><code>“firstName” : “John”</code><br>这很容易理解，等价于这条 JavaScript 语句：<br><code>firstName = “John”</code></p>
<h4 id="json嵌套"><a href="#json嵌套" class="headerlink" title="json嵌套"></a>json嵌套</h4><p>对于json嵌套，只要记住</p>
<ul>
<li>符号<code>：</code>”前是键，符号后是值</li>
<li>大括号成对找</li>
</ul>
<p>一层层剥开，就清楚了。</p>
<h3 id="2-前后台的传输"><a href="#2-前后台的传输" class="headerlink" title="2)前后台的传输"></a>2)前后台的传输</h3><ul>
<li>JSON.parseObject，是将Json字符串转化为相应的对象</li>
<li>JSON.toJSONString则是将对象转化为Json字符串。</li>
</ul>
<h2 id="2-7-EventType"><a href="#2-7-EventType" class="headerlink" title="2.7 EventType"></a>2.7 EventType</h2><p>EventType 是获得活动的类型，可以有点赞，评论，登陆等待</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EventType &#123;</span><br><span class="line">    LIKE(<span class="number">0</span>),</span><br><span class="line">    COMMENT(<span class="number">1</span>),</span><br><span class="line">    LOGIN(<span class="number">2</span>),</span><br><span class="line">    MAIL(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    EventType(<span class="keyword">int</span> value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-configuration"><a href="#3-configuration" class="headerlink" title="3. configuration"></a>3. configuration</h1><h2 id="3-1-ToutiaoWebConfiguration"><a href="#3-1-ToutiaoWebConfiguration" class="headerlink" title="3.1. ToutiaoWebConfiguration"></a>3.1. ToutiaoWebConfiguration</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToutiaoWebConfiguration</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PassportInterceptor passportInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LoginRequiredInterceptor loginRequiredInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(passportInterceptor);</span><br><span class="line">        registry.addInterceptor(loginRequiredInterceptor).</span><br><span class="line">                addPathPatterns(<span class="string">"/msg/*"</span>).addPathPatterns(<span class="string">"/like"</span>).addPathPatterns(<span class="string">"/dislike"</span>);</span><br><span class="line">        <span class="keyword">super</span>.addInterceptors(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-spring-boot中使用拦截器"><a href="#1-spring-boot中使用拦截器" class="headerlink" title="1)spring boot中使用拦截器"></a>1)spring boot中使用拦截器</h3><h4 id="1、注册拦截器"><a href="#1、注册拦截器" class="headerlink" title="1、注册拦截器"></a>1、注册拦截器</h4><p>创建一个类MyWebConfig继承<code>WebMvcConfigurerAdapter</code>，并重写<code>addInterceptors</code>方法</p>
<p>多个拦截器组成一个<strong>拦截器链</strong></p>
<ul>
<li>addPathPatterns<br>添加拦截规则</li>
<li>excludePathPatterns<br>排除拦截</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class MyWebConfig extends WebMvcConfigurerAdapter &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    MyiInterceptor myiInterceptor;</span><br><span class="line"></span><br><span class="line">    @Override    //注册 拦截器</span><br><span class="line">    public void addInterceptors(InterceptorRegistry registry) &#123;</span><br><span class="line">//拦截器myiInterceptor只拦截&apos;/111&apos;的请求，不拦截&apos;/helloWorld&apos;      </span><br><span class="line">        registry.addInterceptor(myiInterceptor).addPathPatterns(&quot;/111&quot;)</span><br><span class="line">                          .excludePathPatterns(&quot;/helloWorld&quot;);</span><br><span class="line">        super.addInterceptors(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、自定义拦截器"><a href="#2、自定义拦截器" class="headerlink" title="2、自定义拦截器"></a>2、自定义拦截器</h4><p>创建一个自定义拦截器MyiInterceptor<code>实现HandlerInterceptor接口</code>，<code>重写所有的方法</code>实现自己的业务（见下面的章节–）</p>
<h1 id="4-controller"><a href="#4-controller" class="headerlink" title="4. controller"></a>4. controller</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/54902062.jpg" alt="controller"></p>
<h2 id="4-1-HomeController"><a href="#4-1-HomeController" class="headerlink" title="4.1. HomeController"></a>4.1. HomeController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    NewsService newsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LikeService likeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MailSender mailSender;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;ViewObject&gt; <span class="title">getNews</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        List&lt;News&gt; newsList = newsService.getLatestNews(userId, offset, limit);</span><br><span class="line">        <span class="keyword">int</span> localUserId = hostHolder.getUser() != <span class="keyword">null</span> ? hostHolder.getUser().getId() : <span class="number">0</span>;</span><br><span class="line">        List&lt;ViewObject&gt; vos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (News news : newsList) &#123;</span><br><span class="line">            ViewObject vo = <span class="keyword">new</span> ViewObject();</span><br><span class="line">            vo.set(<span class="string">"news"</span>, news);</span><br><span class="line">            vo.set(<span class="string">"user"</span>, userService.getUser(news.getUserId()));</span><br><span class="line">            <span class="keyword">if</span> (localUserId != <span class="number">0</span>) &#123;</span><br><span class="line">                vo.set(<span class="string">"like"</span>, likeService.getLikeStatus(localUserId, EntityType.ENTITY_NEWS, news.getId()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                vo.set(<span class="string">"like"</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            vos.add(vo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> vos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/"</span>, <span class="string">"/index"</span>&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(Model model,</span></span></span><br><span class="line"><span class="function"><span class="params">                        @RequestParam(value = <span class="string">"pop"</span>, defaultValue = <span class="string">"0"</span>)</span> <span class="keyword">int</span> pop) </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"vos"</span>, getNews(<span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="keyword">if</span> (hostHolder.getUser() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pop = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">"pop"</span>, pop);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"home"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/user/&#123;userId&#125;"</span>&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">userIndex</span><span class="params">(Model model, @PathVariable(<span class="string">"userId"</span>)</span> <span class="keyword">int</span> userId) </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"vos"</span>, getNews(userId, <span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"home"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-IndexController"><a href="#4-2-IndexController" class="headerlink" title="4.2. IndexController"></a>4.2. IndexController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(IndexController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ToutiaoService toutiaoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/"</span>, <span class="string">"/index"</span>&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(HttpSession session)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"Visit Index"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello NowCoder,"</span> + session.getAttribute(<span class="string">"msg"</span>)</span><br><span class="line">                + <span class="string">"&lt;br&gt; Say:"</span> + toutiaoService.say();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = &#123;<span class="string">"/profile/&#123;groupId&#125;/&#123;userId&#125;"</span>&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">profile</span><span class="params">(@PathVariable(<span class="string">"groupId"</span>)</span> String groupId,</span></span><br><span class="line"><span class="function">                          @<span class="title">PathVariable</span><span class="params">(<span class="string">"userId"</span>)</span> <span class="keyword">int</span> userId,</span></span><br><span class="line"><span class="function">                          @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"type"</span>, defaultValue = <span class="string">"1"</span>)</span> <span class="keyword">int</span> type,</span></span><br><span class="line"><span class="function">                          @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"key"</span>, defaultValue = <span class="string">"nowcoder"</span>)</span> String key) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"GID&#123;%s&#125;,UID&#123;%d&#125;,TYPE&#123;%d&#125;,KEY&#123;%s&#125;"</span>, groupId, userId, type, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = &#123;<span class="string">"/vm"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">news</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"value1"</span>, <span class="string">"vv1"</span>);</span><br><span class="line">        List&lt;String&gt; colors = Arrays.asList(<span class="keyword">new</span> String[]&#123;<span class="string">"RED"</span>, <span class="string">"GREEN"</span>, <span class="string">"BLUE"</span>&#125;);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">            map.put(String.valueOf(i), String.valueOf(i * i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">"colors"</span>, colors);</span><br><span class="line">        model.addAttribute(<span class="string">"map"</span>, map);</span><br><span class="line">        model.addAttribute(<span class="string">"user"</span>, <span class="keyword">new</span> User(<span class="string">"Jim"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"news"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = &#123;<span class="string">"/request"</span>&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">request</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                          HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                          HttpSession session)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span><br><span class="line">        <span class="keyword">while</span> (headerNames.hasMoreElements()) &#123;</span><br><span class="line">            String name = headerNames.nextElement();</span><br><span class="line">            sb.append(name + <span class="string">":"</span> + request.getHeader(name) + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Cookie cookie : request.getCookies()) &#123;</span><br><span class="line">            sb.append(<span class="string">"Cookie:"</span>);</span><br><span class="line">            sb.append(cookie.getName());</span><br><span class="line">            sb.append(<span class="string">":"</span>);</span><br><span class="line">            sb.append(cookie.getValue());</span><br><span class="line">            sb.append(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sb.append(<span class="string">"getMethod:"</span> + request.getMethod() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        sb.append(<span class="string">"getPathInfo:"</span> + request.getPathInfo() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        sb.append(<span class="string">"getQueryString:"</span> + request.getQueryString() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        sb.append(<span class="string">"getRequestURI:"</span> + request.getRequestURI() + <span class="string">"&lt;br&gt;"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = &#123;<span class="string">"/response"</span>&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">response</span><span class="params">(@CookieValue(value = <span class="string">"nowcoderid"</span>, defaultValue = <span class="string">"a"</span>)</span> String nowcoderId,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"key"</span>, defaultValue = <span class="string">"key"</span>)</span> String key,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"value"</span>, defaultValue = <span class="string">"value"</span>)</span> String value,</span></span><br><span class="line"><span class="function">                           HttpServletResponse response) </span>&#123;</span><br><span class="line">        response.addCookie(<span class="keyword">new</span> Cookie(key, value));</span><br><span class="line">        response.addHeader(key, value);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"NowCoderId From Cookie:"</span> + nowcoderId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/redirect/&#123;code&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">redirect</span><span class="params">(@PathVariable(<span class="string">"code"</span>)</span> <span class="keyword">int</span> code,</span></span><br><span class="line"><span class="function">                           HttpSession session) </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        RedirectView red = new RedirectView("/", true);</span></span><br><span class="line"><span class="comment">        if (code == 301) &#123;</span></span><br><span class="line"><span class="comment">            red.setStatusCode(HttpStatus.MOVED_PERMANENTLY);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return red;*/</span></span><br><span class="line">        session.setAttribute(<span class="string">"msg"</span>, <span class="string">"Jump from redirect."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/admin"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">(@RequestParam(value = <span class="string">"key"</span>, required = <span class="keyword">false</span>)</span> String key) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"admin"</span>.equals(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"hello admin"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Key 错误"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>()</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">error</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error:"</span> + e.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-model-addAttribute-quot-k-quot-v"><a href="#1-model-addAttribute-quot-k-quot-v" class="headerlink" title="1)model.addAttribute(&quot;k&quot;,v)"></a>1)<code>model.addAttribute(&quot;k&quot;,v)</code></h3><p>model.addAttribute(“editPageFlg”,editPageFlg)的作用：类似于hashmap。</p>
<p>向Map里面添加键值对，key=”editPageFlg”，value=editPageFlg。</p>
<p>此类来源于ModelMap的定义，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelMap</span> <span class="keyword">extends</span> <span class="title">LinkHashMap</span>&lt;<span class="title">String</span>,<span class="title">Object</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中addAttribute的源码为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public ModelMap addAttribute(String attributeName, Object attributeValue)&#123;</span><br><span class="line">    Assert.notNull(attributeName, &quot;Model attribute name must not be null&quot;);</span><br><span class="line">    put(attributeName, attributeValue);</span><br><span class="line">    return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在put之前，会进行判空检测。这就是addAttribute与put的区别。</p>
<h3 id="2-CookieValue"><a href="#2-CookieValue" class="headerlink" title="2)@CookieValue"></a>2)@CookieValue</h3><h4 id="CookieValue的作用"><a href="#CookieValue的作用" class="headerlink" title="@CookieValue的作用"></a>@CookieValue的作用</h4><p>用来获取<code>Cookie中的值</code></p>
<h4 id="CookieValue参数"><a href="#CookieValue参数" class="headerlink" title="@CookieValue参数"></a>@CookieValue参数</h4><p>1、value：参数名称<br>2、required：是否必须<br>3、defaultValue：默认值</p>
<h3 id="3-用-JSP-设置-Cookies"><a href="#3-用-JSP-设置-Cookies" class="headerlink" title="3)用 JSP 设置 Cookies"></a>3)用 JSP 设置 Cookies</h3><p>用 JSP 设置 Cookies 包括三个步骤：</p>
<ul>
<li>(1) 创建一个 Cookie 对象<br>用 cookie 的名称和值调用 cookie 构造函数，名称和值是字符串。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"key"</span>,<span class="string">"value"</span>);</span><br></pre></td></tr></table></figure>
<p>这个名字和值都不应该包含空格或任何以下字符：<code>[ ] ( ) = , &quot; / ? @ : ;</code></p>
<ul>
<li>(2) 设置最大持续时间<br>使用 <code>setMaxAge</code> 指定 cookie 的有效期是多长时间(以秒为单位)。以下是建立了一个持续 24 小时的 cookie。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie.setMaxAge(<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>(3) 将 cookie 发送到 HTTP 响应标题中<br>使用<code>response.addCookie</code> 在 HTTP 响应标题中添加 cookies，如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.addCookie(cookie);</span><br></pre></td></tr></table></figure>
<h3 id="4-request和response方法的总结"><a href="#4-request和response方法的总结" class="headerlink" title="4)request和response方法的总结"></a>4)request和response方法的总结</h3><h4 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h4><p>JSP中的隐藏对象 – <code>request</code></p>
<p><code>request</code>可以在JSP网页中使用,在转译为Servlet之后,它会转换为<code>javax.servlet.http.HttpServletRequest</code>型态的对象，HttpServletRequest对象是有关于客户端所发出的请求之对象，只要是有关于客户端请求的信息，都可以藉由它来取得，例如请求标头、请求方法、请求参数、使用者IP等等信息。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>getParameterNames()</td>
<td>取得客户端所发出的请求参数名称</td>
</tr>
<tr>
<td>getParameter()</td>
<td>可以让您指定请求参数名称，以取得对应的设定值</td>
</tr>
<tr>
<td>getServerName()</td>
<td>请求的服务器</td>
</tr>
<tr>
<td>getProtocol()</td>
<td>使用协议</td>
</tr>
<tr>
<td>getMethod()</td>
<td>请求方法</td>
</tr>
<tr>
<td>getServerPort()</td>
<td>请求端口号</td>
</tr>
<tr>
<td>getContextPath()</td>
<td>Context路径. context理解为上下文比较好（也就是一个项目）</td>
</tr>
<tr>
<td>getServletPath()</td>
<td>Servlet路径</td>
</tr>
<tr>
<td>getRequestURI()</td>
<td>URI路径</td>
</tr>
<tr>
<td>getQueryString()</td>
<td>查询字符串</td>
</tr>
<tr>
<td>getRemoteAddr()</td>
<td>使用者主机IP</td>
</tr>
<tr>
<td>getRemotePort()</td>
<td>使用者使用端口号</td>
</tr>
</tbody>
</table>
<h4 id="response"><a href="#response" class="headerlink" title="response"></a>response</h4><p>JSP中的隐藏对象 –<code>response</code><br>JSP的<code>response</code>隐藏对象在转换为Servlet之后，对应于HttpServletResponse型态对象，<code>HttpServletResponse</code>对象是有关于对客户端请求之响应，您可以利用它来设定一些要响应的讯息，例如标题信息、响应状态码等. 　<br>　<br>|方法|作用|<br>|—|—|<br>|setHeader()|是一个通用的标头设定方法，您可以用它来设定任何「名称/值」的标头|<br>|setIntHeader()|是专门用来设定整数值标头的版本|<br>|setDateHeader()|是setHeader()的Date设定版本，第二个参数是设定Date的Long数值，0表示GMT 1970/1/1 00:00。<br>|setStatus()|是用来设定回应的状态码，例如404 Not Found，HttpServletResponse类中提供了一些助忆常数设定，例如SC_NOT_FOUND就是表示404状态码（可以在Servlet API文件中查询相关的助忆常数）|<br>|sendError()|会根据服务器的预设错误网页回报方式显示错误讯息|<br>|sendRedirect()|设置重定向页面|<br>|getWriter()|取得PrintWriter对象，由它来写出响应至服务器的本体信息|</p>
<h3 id="5-HttpServletResponse和HttpServletRequest"><a href="#5-HttpServletResponse和HttpServletRequest" class="headerlink" title="5)HttpServletResponse和HttpServletRequest"></a>5)HttpServletResponse和HttpServletRequest</h3><p><a href="https://blog.csdn.net/axi295309066/article/details/52959741#t12" target="_blank" rel="noopener">HttpServletResponse和HttpServletRequest</a></p>
<p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-25/45752559.jpg" alt="请求响应流程图"></p>
<h4 id="Request-1"><a href="#Request-1" class="headerlink" title="Request"></a>Request</h4><p>Request是Servlet.service()方法的一个参数，类型为<code>javax.servlet.http.HttpServletRequest</code>。在客户端发出每个请求时，服务器都会创建一个request对象，并把请求数据封装到request中，然后在调用Servlet.service()方法时传递给service()方法，这说明在service()方法中可以<strong>通过request对象来获取请求数据</strong></p>
<p>Request的功能可以分为以下几种：</p>
<ul>
<li>封装了请求头数据</li>
<li>封装了请求正文数据，如果是GET请求，那么就没有正文</li>
<li>request是一个域对象，可以把它当成Map来添加获取数据</li>
<li>request提供了请求转发和请求包含功能</li>
</ul>
<p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-25/86026975.jpg" alt="Request的一些get...()"></p>
<h4 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h4><p>Response是Servlet.service方法的一个参数，类型为<code>javax.servlet.http.HttpServletResponse</code>。在客户端发出每个请求时，服务器都会创建一个response对象，并传入给Servlet.service()方法。response对象是用来对客户端进行响应的，这说明在service()方法中<strong>使用response对象可以完成对客户端的响应工作</strong></p>
<p>response对象的功能分为以下四种：</p>
<ul>
<li>设置响应头信息</li>
<li>发送状态码</li>
<li>设置响应正文</li>
<li>重定向</li>
</ul>
<h3 id="6-numeration接口"><a href="#6-numeration接口" class="headerlink" title="6)numeration接口"></a>6)numeration接口</h3><p>Enumeration是java.util中的一个接口类，在Enumeration中封装了有关枚举数据集合的方法，与Iterator差不多，用来遍历集合中的元素  但是枚举Enumeration只提供了遍历<code>Vector和Hashtable</code>类型集合元素的功能，这种类型的集合对象通过调用elements()方法获取一个Enumeration对象  然后Enumeratino对象再调用以下方法来对集合中的元素进行遍历。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Enumeration</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasMoreElements</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">E <span class="title">nextElement</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>boolean hasMoreElements( )</td>
<td>测试此枚举是否包含更多的元素</td>
</tr>
<tr>
<td>Object nextElement( )</td>
<td>如果此枚举对象至少还有一个可提供的元素，则返回此枚举的下一个元素</td>
</tr>
</tbody>
</table>
<h3 id="7-Iterator接口"><a href="#7-Iterator接口" class="headerlink" title="7)Iterator接口"></a>7)Iterator接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">E <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-Spring-MVC-重定向常用处理方式"><a href="#8-Spring-MVC-重定向常用处理方式" class="headerlink" title="8) Spring MVC 重定向常用处理方式"></a>8) Spring MVC 重定向常用处理方式</h3><p>Controller 视图方法间的跳转，无非就是带参跳转和不带参跳转。常用的方法有通过 <code>String 映射 RequestMapping</code>实现重定向，或者通过 <code>ModelAndView</code> 对象，又或者是 <code>RedirectView</code> 对象，下面逐一说明。</p>
<h3 id="String-重定向"><a href="#String-重定向" class="headerlink" title="String 重定向"></a>String 重定向</h3><p>是 return 映射到另一个 Controller 方法的字符串。如果有请求参数，就拼接在 RequestMapping 映射的字符串后面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 返回字符串映射的方式</span><br><span class="line">@RequestMapping(&quot;hello&quot;)</span><br><span class="line">public String hello(HttpServletRequest req, HttpServletResponse resp) &#123;</span><br><span class="line">    doSomething();</span><br><span class="line">    return &quot;redirect:/bye&quot;;</span><br><span class="line"> // return &quot;redirect:/bye?username=yxd&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ModelAndView-重定向"><a href="#ModelAndView-重定向" class="headerlink" title="ModelAndView 重定向"></a>ModelAndView 重定向</h3><p>另一种方法是通过返回 <code>ModelAndView</code> 对象来实现跳转。类似的，如果有请求参数，也可以通过类似 GET 参数拼接的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 返回 ModelAndView 对象</span><br><span class="line">@RequestMapping(&quot;hello&quot;)</span><br><span class="line">public ModelAndView hello(HttpServletRequest req, HttpServletResponse resp) &#123;</span><br><span class="line">    doSomething();</span><br><span class="line">    return new ModelAndView(&quot;redirect:/bye&quot;);</span><br><span class="line"> // return new ModelAndView(&quot;redirect:/bye?username=yxd&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RedirectView-重定向"><a href="#RedirectView-重定向" class="headerlink" title="RedirectView 重定向"></a>RedirectView 重定向</h3><p>还有一种方法是通过返回 <code>RedirectView</code> 对象实现跳转，该方法和上面的不同之处在于，<code>RedirectView</code> 对象不需要设置 redirect 前缀：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 返回 RedirectView 对象</span><br><span class="line">@RequestMapping(&quot;hello&quot;)</span><br><span class="line">public RedirectView hello() &#123;</span><br><span class="line">    doSomething();</span><br><span class="line">    return new RedirectView(&quot;/bye&quot;);</span><br><span class="line"> // return new RedirectView(&quot;bye?username=yxd&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-LikeController"><a href="#4-3-LikeController" class="headerlink" title="4.3. LikeController"></a>4.3. LikeController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LikeController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LikeService likeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    NewsService newsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EventProducer eventProducer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/like"</span>&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">like</span><span class="params">(@Param(<span class="string">"newId"</span>)</span> <span class="keyword">int</span> newsId) </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> likeCount = likeService.like(hostHolder.getUser().getId(), EntityType.ENTITY_NEWS, newsId);</span><br><span class="line">        System.out.println(<span class="string">"like likecount "</span> + likeCount);<span class="comment">//20180802</span></span><br><span class="line">        <span class="comment">// 更新喜欢数</span></span><br><span class="line">        News news = newsService.getById(newsId);</span><br><span class="line">        newsService.updateLikeCount(newsId, (<span class="keyword">int</span>) likeCount);</span><br><span class="line"></span><br><span class="line">        eventProducer.fireEvent(<span class="keyword">new</span> EventModel(EventType.LIKE)</span><br><span class="line">                .setActorId(hostHolder.getUser().getId()).setEntityId(newsId)</span><br><span class="line">                .setEntityType(EntityType.ENTITY_NEWS).setEntityOwnerId(news.getUserId()));</span><br><span class="line">        <span class="comment">//return  "redirect:/";  //20180802</span></span><br><span class="line">        <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">0</span>, String.valueOf(likeCount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/dislike"</span>&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">dislike</span><span class="params">(@Param(<span class="string">"newId"</span>)</span> <span class="keyword">int</span> newsId) </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> likeCount = likeService.disLike(hostHolder.getUser().getId(), EntityType.ENTITY_NEWS, newsId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新喜欢数</span></span><br><span class="line">        newsService.updateLikeCount(newsId, (<span class="keyword">int</span>) likeCount);</span><br><span class="line">        <span class="comment">//return  "redirect:/";  //20180802</span></span><br><span class="line">        <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">0</span>, String.valueOf(likeCount));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-LoginController"><a href="#4-4-LoginController" class="headerlink" title="4.4. LoginController"></a>4.4. LoginController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(LoginController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    EventProducer eventProducer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/reg/"</span>&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">reg</span><span class="params">(Model model, @RequestParam(<span class="string">"username"</span>)</span> String username,</span></span><br><span class="line"><span class="function">                      @<span class="title">RequestParam</span><span class="params">(<span class="string">"password"</span>)</span> String password,</span></span><br><span class="line"><span class="function">                      @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"rember"</span>, defaultValue = <span class="string">"0"</span>)</span> <span class="keyword">int</span> rememberme,</span></span><br><span class="line"><span class="function">                      HttpServletResponse response) </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"/reg/ "</span> + username + <span class="string">" "</span> + password + <span class="string">" "</span> + rememberme);<span class="comment">//20180802</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = userService.register(username, password);</span><br><span class="line">            <span class="keyword">if</span> (map.containsKey(<span class="string">"ticket"</span>)) &#123;</span><br><span class="line">                Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"ticket"</span>, map.get(<span class="string">"ticket"</span>).toString());</span><br><span class="line">                cookie.setPath(<span class="string">"/"</span>);</span><br><span class="line">                <span class="keyword">if</span> (rememberme &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    cookie.setMaxAge(<span class="number">3600</span> * <span class="number">24</span> * <span class="number">5</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                response.addCookie(cookie);</span><br><span class="line">                logger.info(<span class="string">"cookie : "</span> + cookie.getValue() +<span class="string">" "</span> + cookie.getName());<span class="comment">//20180802</span></span><br><span class="line">                <span class="comment">//return "redirect:/";</span></span><br><span class="line">                <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">0</span>, <span class="string">"注册成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                model.addAttribute(<span class="string">"error"</span>,<span class="string">"注册失败，请重新注册"</span>);<span class="comment">//20180802</span></span><br><span class="line">                <span class="comment">//return "redirect:/register";//20180802</span></span><br><span class="line">                <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">1</span>, map);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"注册异常"</span> + e.getMessage());</span><br><span class="line">            model.addAttribute(<span class="string">"error"</span>,<span class="string">"注册异常"</span>);<span class="comment">//20180802</span></span><br><span class="line">            <span class="comment">//return "redirect:/register";//20180802</span></span><br><span class="line">            <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">1</span>, <span class="string">"注册异常"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @RequestMapping(value = "/login",method = RequestMethod.GET)</span></span><br><span class="line"><span class="comment">//    public String login()&#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        return "login";</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    @RequestMapping(value = "/register",method = RequestMethod.GET)</span></span><br><span class="line"><span class="comment">//    public String register()&#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        return "register";</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/login/"</span>&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(Model model, @RequestParam(<span class="string">"username"</span>)</span> String username,</span></span><br><span class="line"><span class="function">                        @<span class="title">RequestParam</span><span class="params">(<span class="string">"password"</span>)</span> String password,</span></span><br><span class="line"><span class="function">                        @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"rember"</span>, defaultValue = <span class="string">"0"</span>)</span> <span class="keyword">int</span> rememberme,</span></span><br><span class="line"><span class="function">                        HttpServletResponse response) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = userService.login(username, password);</span><br><span class="line">            <span class="keyword">if</span> (map.containsKey(<span class="string">"ticket"</span>)) &#123;</span><br><span class="line">                Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"ticket"</span>, map.get(<span class="string">"ticket"</span>).toString());</span><br><span class="line">                cookie.setPath(<span class="string">"/"</span>);</span><br><span class="line">                <span class="keyword">if</span> (rememberme &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    cookie.setMaxAge(<span class="number">3600</span> * <span class="number">24</span> * <span class="number">5</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                response.addCookie(cookie);</span><br><span class="line">                eventProducer.fireEvent(<span class="keyword">new</span> EventModel(EventType.LOGIN)</span><br><span class="line">                        .setActorId((<span class="keyword">int</span>) map.get(<span class="string">"userId"</span>))</span><br><span class="line">                        .setExt(<span class="string">"username"</span>, username).setExt(<span class="string">"email"</span>, <span class="string">"1751341161@qq.com"</span>));</span><br><span class="line">                <span class="comment">//return "redirect:/";//20180802</span></span><br><span class="line">                <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">0</span>, <span class="string">"成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                model.addAttribute(<span class="string">"error"</span>,<span class="string">"登录失败,请重新登录!"</span>);<span class="comment">//20180802</span></span><br><span class="line">                <span class="comment">//return "redirect:/login";//20180802</span></span><br><span class="line">                <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">1</span>, map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"注册异常"</span> + e.getMessage());</span><br><span class="line">            model.addAttribute(<span class="string">"error"</span>,<span class="string">"登录异常"</span>);<span class="comment">//20180802</span></span><br><span class="line">            <span class="comment">//return "redirect:/login";//20180802</span></span><br><span class="line">            <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">1</span>, <span class="string">"注册异常"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/logout/"</span>&#125;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">logout</span><span class="params">(@CookieValue(<span class="string">"ticket"</span>)</span> String ticket) </span>&#123;</span><br><span class="line">        userService.logout(ticket);</span><br><span class="line">        logger.info(<span class="string">"logout：跳转到首页"</span>);<span class="comment">//20180802  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-5-MessageController"><a href="#4-5-MessageController" class="headerlink" title="4.5 MessageController"></a>4.5 MessageController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MessageController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/msg/list"</span>&#125;, method = &#123;RequestMethod.GET&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">conversationDetail</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> localUserId = hostHolder.getUser().getId();</span><br><span class="line">            List&lt;ViewObject&gt; conversations = <span class="keyword">new</span> ArrayList&lt;ViewObject&gt;();</span><br><span class="line">            List&lt;Message&gt; conversationList = messageService.getConversationList(localUserId, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">for</span> (Message msg : conversationList) &#123;</span><br><span class="line">                ViewObject vo = <span class="keyword">new</span> ViewObject();</span><br><span class="line">                vo.set(<span class="string">"conversation"</span>, msg);</span><br><span class="line">                <span class="keyword">int</span> targetId = msg.getFromId() == localUserId ? msg.getToId() : msg.getFromId();</span><br><span class="line">                User user = userService.getUser(targetId);</span><br><span class="line">                vo.set(<span class="string">"user"</span>, user);</span><br><span class="line">                vo.set(<span class="string">"unread"</span>, messageService.getConvesationUnreadCount(localUserId, msg.getConversationId()));</span><br><span class="line">                conversations.add(vo);</span><br><span class="line">            &#125;</span><br><span class="line">            model.addAttribute(<span class="string">"conversations"</span>, conversations);</span><br><span class="line">            <span class="comment">//return "letter";//20180802</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"获取站内信列表失败"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"letter"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/msg/detail"</span>&#125;, method = &#123;RequestMethod.GET&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">conversationDetail</span><span class="params">(Model model, @Param(<span class="string">"conversationId"</span>)</span> String conversationId) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;Message&gt; conversationList = messageService.getConversationDetail(conversationId, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">            List&lt;ViewObject&gt; messages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Message msg : conversationList) &#123;</span><br><span class="line">                ViewObject vo = <span class="keyword">new</span> ViewObject();</span><br><span class="line">                vo.set(<span class="string">"message"</span>, msg);</span><br><span class="line">                User user = userService.getUser(msg.getFromId());</span><br><span class="line">                <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                vo.set(<span class="string">"headUrl"</span>, user.getHeadUrl());</span><br><span class="line">                vo.set(<span class="string">"userId"</span>, user.getId());</span><br><span class="line">                messages.add(vo);</span><br><span class="line">            &#125;</span><br><span class="line">            model.addAttribute(<span class="string">"messages"</span>, messages);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"获取详情消息失败"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"letterDetail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/msg/addMessage"</span>&#125;, method = &#123;RequestMethod.POST&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addMessage</span><span class="params">(@RequestParam(<span class="string">"fromId"</span>)</span> <span class="keyword">int</span> fromId,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(<span class="string">"toId"</span>)</span> <span class="keyword">int</span> toId,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(<span class="string">"content"</span>)</span> String content) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Message msg = <span class="keyword">new</span> Message();</span><br><span class="line">            msg.setContent(content);</span><br><span class="line">            msg.setFromId(fromId);</span><br><span class="line">            msg.setToId(toId);</span><br><span class="line">            msg.setCreatedDate(<span class="keyword">new</span> Date());</span><br><span class="line">            <span class="comment">//msg.setConversationId(fromId &lt; toId ? String.format("%d_%d", fromId, toId) : String.format("%d_%d", toId, fromId));</span></span><br><span class="line">            messageService.addMessage(msg);</span><br><span class="line">            <span class="keyword">return</span> ToutiaoUtil.getJSONString(msg.getId());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"增加评论失败"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">1</span>, <span class="string">"插入评论失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-6-NewsController"><a href="#4-6-NewsController" class="headerlink" title="4.6 NewsController"></a>4.6 NewsController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(NewsController.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    NewsService newsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    QiniuService qiniuService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CommentService commentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LikeService likeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/news/&#123;newsId&#125;"</span>&#125;, method = &#123;RequestMethod.GET&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">newsDetail</span><span class="params">(@PathVariable(<span class="string">"newsId"</span>)</span> <span class="keyword">int</span> newsId, Model model) </span>&#123;</span><br><span class="line">        News news = newsService.getById(newsId);</span><br><span class="line">        <span class="keyword">if</span> (news != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> localUserId = hostHolder.getUser() != <span class="keyword">null</span> ? hostHolder.getUser().getId() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (localUserId != <span class="number">0</span>) &#123;</span><br><span class="line">                model.addAttribute(<span class="string">"like"</span>, likeService.getLikeStatus(localUserId, EntityType.ENTITY_NEWS, news.getId()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                model.addAttribute(<span class="string">"like"</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 评论</span></span><br><span class="line">            List&lt;Comment&gt; comments = commentService.getCommentsByEntity(news.getId(), EntityType.ENTITY_NEWS);</span><br><span class="line">            List&lt;ViewObject&gt; commentVOs = <span class="keyword">new</span> ArrayList&lt;ViewObject&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Comment comment : comments) &#123;</span><br><span class="line">                ViewObject vo = <span class="keyword">new</span> ViewObject();</span><br><span class="line">                vo.set(<span class="string">"comment"</span>, comment);</span><br><span class="line">                vo.set(<span class="string">"user"</span>, userService.getUser(comment.getUserId()));</span><br><span class="line">                commentVOs.add(vo);</span><br><span class="line">            &#125;</span><br><span class="line">            model.addAttribute(<span class="string">"comments"</span>, commentVOs);</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">"news"</span>, news);</span><br><span class="line">        model.addAttribute(<span class="string">"owner"</span>, userService.getUser(news.getUserId()));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"detail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/addComment"</span>&#125;, method = &#123;RequestMethod.POST&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addComment</span><span class="params">(@RequestParam(<span class="string">"newsId"</span>)</span> <span class="keyword">int</span> newsId,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(<span class="string">"content"</span>)</span> String content) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            content = HtmlUtils.htmlEscape(content);</span><br><span class="line">            <span class="comment">// 过滤content</span></span><br><span class="line">            Comment comment = <span class="keyword">new</span> Comment();</span><br><span class="line">            comment.setUserId(hostHolder.getUser().getId());</span><br><span class="line">            comment.setContent(content);</span><br><span class="line">            comment.setEntityId(newsId);</span><br><span class="line">            comment.setEntityType(EntityType.ENTITY_NEWS);</span><br><span class="line">            comment.setCreatedDate(<span class="keyword">new</span> Date());</span><br><span class="line">            comment.setStatus(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            commentService.addComment(comment);</span><br><span class="line">            <span class="comment">// 更新news里的评论数量</span></span><br><span class="line">            <span class="keyword">int</span> count = commentService.getCommentCount(comment.getEntityId(), comment.getEntityType());</span><br><span class="line">            newsService.updateCommentCount(comment.getEntityId(), count);</span><br><span class="line">            <span class="comment">// 怎么异步化</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"增加评论失败"</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/news/"</span> + String.valueOf(newsId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/image"</span>&#125;, method = &#123;RequestMethod.GET&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getImage</span><span class="params">(@RequestParam(<span class="string">"name"</span>)</span> String imageName,</span></span><br><span class="line"><span class="function">                         HttpServletResponse response) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.setContentType(<span class="string">"image/jpeg"</span>);</span><br><span class="line">            StreamUtils.copy(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span></span><br><span class="line">                    File(ToutiaoUtil.IMAGE_DIR + imageName)), response.getOutputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"读取图片错误"</span> + imageName + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/uploadImage/"</span>&#125;, method = &#123;RequestMethod.POST&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">uploadImage</span><span class="params">(@RequestParam(<span class="string">"file"</span>)</span> MultipartFile file) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String fileUrl = newsService.saveImage(file);</span><br><span class="line">            <span class="comment">//String fileUrl = qiniuService.saveImage(file);</span></span><br><span class="line">            <span class="keyword">if</span> (fileUrl == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">1</span>, <span class="string">"上传图片失败"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">0</span>, fileUrl);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"上传图片失败"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">1</span>, <span class="string">"上传失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(path = &#123;<span class="string">"/user/addNews/"</span>&#125;, method = &#123;RequestMethod.POST&#125;)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addNews</span><span class="params">(@RequestParam(<span class="string">"image"</span>)</span> String image,</span></span><br><span class="line"><span class="function">                          @<span class="title">RequestParam</span><span class="params">(<span class="string">"title"</span>)</span> String title,</span></span><br><span class="line"><span class="function">                          @<span class="title">RequestParam</span><span class="params">(<span class="string">"link"</span>)</span> String link) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            News news = <span class="keyword">new</span> News();</span><br><span class="line">            news.setCreatedDate(<span class="keyword">new</span> Date());</span><br><span class="line">            news.setTitle(title);</span><br><span class="line">            news.setImage(image);</span><br><span class="line">            news.setLink(link);</span><br><span class="line">            <span class="keyword">if</span> (hostHolder.getUser() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                news.setUserId(hostHolder.getUser().getId());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 设置一个匿名用户</span></span><br><span class="line">                news.setUserId(<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            newsService.addNews(news);</span><br><span class="line">            <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"添加资讯失败"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> ToutiaoUtil.getJSONString(<span class="number">1</span>, <span class="string">"发布失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-7-SettingController"><a href="#4-7-SettingController" class="headerlink" title="4.7. SettingController"></a>4.7. SettingController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SettingController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/setting"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">setting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Setting:OK"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-RequestBody"><a href="#1-RequestBody" class="headerlink" title="1)@RequestBody"></a>1)@RequestBody</h3><ul>
<li>1.不使用@RequestBody注解<br>相当于使用该注解，并required默认为true<br>①当前端没有传参时，会报错<code>400</code><br>②当前端传一个空{}，对象会根据构造函数自动生成。</li>
<li>2.只使用@RequestBody注解<br>效果同1</li>
<li>3.使用@RequestBody(required = false)<br>可以不传参，但句柄会为<code>null</code></li>
</ul>
<h3 id="2-ResponseBody"><a href="#2-ResponseBody" class="headerlink" title="2)@ResponseBody"></a>2)@ResponseBody</h3><ul>
<li>作用：<br>该注解用于将Controller的方法返回的对象，通过适当的HttpMessageConverter转换为指定格式后，写入到Response对象的body数据区。</li>
<li>使用时机：<br>返回的数据<code>不是html标签的页面</code>，而是其他某种格式的数据时（如json、xml等）使用；</li>
</ul>
<h1 id="5-DAO"><a href="#5-DAO" class="headerlink" title="5. DAO"></a>5. DAO</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/18868142.jpg" alt="DAO"></p>
<h2 id="5-1-CommentDAO"><a href="#5-1-CommentDAO" class="headerlink" title="5.1 CommentDAO"></a>5.1 CommentDAO</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CommentDAO</span> </span>&#123;</span><br><span class="line">    String TABLE_NAME = <span class="string">" comment "</span>;</span><br><span class="line">    String INSERT_FIELDS = <span class="string">" user_id, content, created_date, entity_id, entity_type, status "</span>;</span><br><span class="line">    String SELECT_FIELDS = <span class="string">" id, "</span> + INSERT_FIELDS;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(&#123;<span class="string">"insert into "</span>, TABLE_NAME, <span class="string">"("</span>, INSERT_FIELDS,</span><br><span class="line">            <span class="string">") values (#&#123;userId&#125;,#&#123;content&#125;,#&#123;createdDate&#125;,#&#123;entityId&#125;,#&#123;entityType&#125;,#&#123;status&#125;)"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">addComment</span><span class="params">(Comment comment)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(&#123;<span class="string">"update "</span>, TABLE_NAME, <span class="string">" set status=#&#123;status&#125; where entity_id=#&#123;entityId&#125; and entity_type=#&#123;entityType&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateStatus</span><span class="params">(@Param(<span class="string">"entityId"</span>)</span> <span class="keyword">int</span> entityId, @<span class="title">Param</span><span class="params">(<span class="string">"entityType"</span>)</span> <span class="keyword">int</span> entityType, @<span class="title">Param</span><span class="params">(<span class="string">"status"</span>)</span> <span class="keyword">int</span> status)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select "</span>, SELECT_FIELDS, <span class="string">" from "</span>, TABLE_NAME,</span><br><span class="line">            <span class="string">" where entity_id=#&#123;entityId&#125; and entity_type=#&#123;entityType&#125; order by id desc"</span>&#125;)</span><br><span class="line">    <span class="function">List&lt;Comment&gt; <span class="title">selectByEntity</span><span class="params">(@Param(<span class="string">"entityId"</span>)</span> <span class="keyword">int</span> entityId, @<span class="title">Param</span><span class="params">(<span class="string">"entityType"</span>)</span> <span class="keyword">int</span> entityType)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select count(id) from "</span>, TABLE_NAME, <span class="string">" where entity_id=#&#123;entityId&#125; and entity_type=#&#123;entityType&#125; "</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getCommentCount</span><span class="params">(@Param(<span class="string">"entityId"</span>)</span> <span class="keyword">int</span> entityId, @<span class="title">Param</span><span class="params">(<span class="string">"entityType"</span>)</span> <span class="keyword">int</span> entityType)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-DAO在JavaWeb开发中的定位"><a href="#1-DAO在JavaWeb开发中的定位" class="headerlink" title="1)DAO在JavaWeb开发中的定位"></a>1)DAO在JavaWeb开发中的定位</h3><p><a href="https://www.cnblogs.com/smyhvae/p/4059514.html" target="_blank" rel="noopener">DAO在JavaWeb开发中的定位</a></p>
<blockquote>
<p>一个典型的DAO实现有下列几个组件：<br>1.一个DAO接口(<code>CRUD</code>)<br>2.一个实现DAO接口的具体类<br>3.数据传递对象(DTO)(<code>POJO</code>)：有些时候叫做值对象(VO)或领域模型（domain）</p>
</blockquote>
<h3 id="2-Mapper注解"><a href="#2-Mapper注解" class="headerlink" title="2)@Mapper注解"></a>2)@Mapper注解</h3><p><a href="https://www.cnblogs.com/sonofelice/p/4980161.html" target="_blank" rel="noopener">mybatis对java自定义注解的使用——入门篇</a></p>
<h4 id="作用：持久化"><a href="#作用：持久化" class="headerlink" title="作用：持久化"></a>作用：持久化</h4><ul>
<li>一种持久化方式：<br>在一个包中写一个DAO的接口，在另一个包里面写DAO的实现，使用sqlMapClient来从***-sql.xml中读取相应的sql。</li>
<li>spring+Mybatis的项目，一种新的持久化方式：<br>只写一个dao的接口，在接口的方法中直接注解上用到的sql语句，<code>接口上方多了一个@Mapper注解</code>。</li>
</ul>
<h2 id="5-2-LoginTicketDAO"><a href="#5-2-LoginTicketDAO" class="headerlink" title="5.2 LoginTicketDAO"></a>5.2 LoginTicketDAO</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginTicketDAO</span> </span>&#123;</span><br><span class="line">    String TABLE_NAME = <span class="string">"login_ticket"</span>;</span><br><span class="line">    String INSERT_FIELDS = <span class="string">" user_id, expired, status, ticket "</span>;</span><br><span class="line">    String SELECT_FIELDS = <span class="string">" id, "</span> + INSERT_FIELDS;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(&#123;<span class="string">"insert into "</span>, TABLE_NAME, <span class="string">"("</span>, INSERT_FIELDS,</span><br><span class="line">            <span class="string">") values (#&#123;userId&#125;,#&#123;expired&#125;,#&#123;status&#125;,#&#123;ticket&#125;)"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">addTicket</span><span class="params">(LoginTicket ticket)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select "</span>, SELECT_FIELDS, <span class="string">" from "</span>, TABLE_NAME, <span class="string">" where ticket=#&#123;ticket&#125;"</span>&#125;)</span><br><span class="line">    <span class="function">LoginTicket <span class="title">selectByTicket</span><span class="params">(String ticket)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(&#123;<span class="string">"update "</span>, TABLE_NAME, <span class="string">" set status=#&#123;status&#125; where ticket=#&#123;ticket&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateStatus</span><span class="params">(@Param(<span class="string">"ticket"</span>)</span> String ticket, @<span class="title">Param</span><span class="params">(<span class="string">"status"</span>)</span> <span class="keyword">int</span> status)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-MessageDAO"><a href="#5-3-MessageDAO" class="headerlink" title="5.3 MessageDAO"></a>5.3 MessageDAO</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageDAO</span> </span>&#123;</span><br><span class="line">    String TABLE_NAME = <span class="string">" message "</span>;</span><br><span class="line">    String INSERT_FIELDS = <span class="string">" from_id, to_id, content, has_read, conversation_id, created_date "</span>;</span><br><span class="line">    String SELECT_FIELDS = <span class="string">" id, "</span> + INSERT_FIELDS;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(&#123;<span class="string">"insert into "</span>, TABLE_NAME, <span class="string">"("</span>, INSERT_FIELDS,</span><br><span class="line">            <span class="string">") values (#&#123;fromId&#125;,#&#123;toId&#125;,#&#123;content&#125;,#&#123;hasRead&#125;,#&#123;conversationId&#125;,#&#123;createdDate&#125;)"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">addMessage</span><span class="params">(Message message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select "</span>, SELECT_FIELDS, <span class="string">" from "</span>, TABLE_NAME, <span class="string">" where conversation_id=#&#123;conversationId&#125; order by id desc limit #&#123;offset&#125;, #&#123;limit&#125;"</span>&#125;)</span><br><span class="line">    <span class="function">List&lt;Message&gt; <span class="title">getConversationDetail</span><span class="params">(@Param(<span class="string">"conversationId"</span>)</span> String conversationId,</span></span><br><span class="line"><span class="function">                                        @<span class="title">Param</span><span class="params">(<span class="string">"offset"</span>)</span> <span class="keyword">int</span> offset, @<span class="title">Param</span><span class="params">(<span class="string">"limit"</span>)</span> <span class="keyword">int</span> limit)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select count(id) from "</span>, TABLE_NAME, <span class="string">" where has_read=0 and to_id=#&#123;userId&#125; and conversation_id=#&#123;conversationId&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getConvesationUnreadCount</span><span class="params">(@Param(<span class="string">"userId"</span>)</span> <span class="keyword">int</span> userId, @<span class="title">Param</span><span class="params">(<span class="string">"conversationId"</span>)</span> String conversationId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select "</span>, INSERT_FIELDS, <span class="string">" ,count(id) as id from ( select * from "</span>, TABLE_NAME, <span class="string">" where from_id=#&#123;userId&#125; or to_id=#&#123;userId&#125; order by id desc) tt group by conversation_id  order by created_date desc limit #&#123;offset&#125;, #&#123;limit&#125;"</span>&#125;)</span><br><span class="line">    <span class="function">List&lt;Message&gt; <span class="title">getConversationList</span><span class="params">(@Param(<span class="string">"userId"</span>)</span> <span class="keyword">int</span> userId,</span></span><br><span class="line"><span class="function">                                      @<span class="title">Param</span><span class="params">(<span class="string">"offset"</span>)</span> <span class="keyword">int</span> offset, @<span class="title">Param</span><span class="params">(<span class="string">"limit"</span>)</span> <span class="keyword">int</span> limit)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-4-NewsDAO"><a href="#5-4-NewsDAO" class="headerlink" title="5.4 NewsDAO"></a>5.4 NewsDAO</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NewsDAO</span> </span>&#123;</span><br><span class="line">    String TABLE_NAME = <span class="string">"news"</span>;</span><br><span class="line">    String INSERT_FIELDS = <span class="string">" title, link, image, like_count, comment_count, created_date, user_id "</span>;</span><br><span class="line">    String SELECT_FIELDS = <span class="string">" id, "</span> + INSERT_FIELDS;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(&#123;<span class="string">"insert into "</span>, TABLE_NAME, <span class="string">"("</span>, INSERT_FIELDS,</span><br><span class="line">            <span class="string">") values (#&#123;title&#125;,#&#123;link&#125;,#&#123;image&#125;,#&#123;likeCount&#125;,#&#123;commentCount&#125;,#&#123;createdDate&#125;,#&#123;userId&#125;)"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">addNews</span><span class="params">(News news)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select "</span>, SELECT_FIELDS , <span class="string">" from "</span>, TABLE_NAME, <span class="string">" where id=#&#123;id&#125;"</span>&#125;)</span><br><span class="line">    <span class="function">News <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(&#123;<span class="string">"update "</span>, TABLE_NAME, <span class="string">" set comment_count = #&#123;commentCount&#125; where id=#&#123;id&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateCommentCount</span><span class="params">(@Param(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id, @<span class="title">Param</span><span class="params">(<span class="string">"commentCount"</span>)</span> <span class="keyword">int</span> commentCount)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(&#123;<span class="string">"update "</span>, TABLE_NAME, <span class="string">" set like_count = #&#123;likeCount&#125; where id=#&#123;id&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateLikeCount</span><span class="params">(@Param(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id, @<span class="title">Param</span><span class="params">(<span class="string">"likeCount"</span>)</span> <span class="keyword">int</span> likeCount)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;News&gt; <span class="title">selectByUserIdAndOffset</span><span class="params">(@Param(<span class="string">"userId"</span>)</span> <span class="keyword">int</span> userId, @<span class="title">Param</span><span class="params">(<span class="string">"offset"</span>)</span> <span class="keyword">int</span> offset,</span></span><br><span class="line"><span class="function">                                       @<span class="title">Param</span><span class="params">(<span class="string">"limit"</span>)</span> <span class="keyword">int</span> limit)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-5-UserDAO"><a href="#5-5-UserDAO" class="headerlink" title="5.5 UserDAO"></a>5.5 UserDAO</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDAO</span> </span>&#123;</span><br><span class="line">    String TABLE_NAME = <span class="string">"user"</span>;</span><br><span class="line">    String INSET_FIELDS = <span class="string">" name, password, salt, head_url "</span>;</span><br><span class="line">    String SELECT_FIELDS = <span class="string">" id, name, password, salt, head_url"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(&#123;<span class="string">"insert into "</span>, TABLE_NAME, <span class="string">"("</span>, INSET_FIELDS,</span><br><span class="line">            <span class="string">") values (#&#123;name&#125;,#&#123;password&#125;,#&#123;salt&#125;,#&#123;headUrl&#125;)"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">addUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select "</span>, SELECT_FIELDS, <span class="string">" from "</span>, TABLE_NAME, <span class="string">" where id=#&#123;id&#125;"</span>&#125;)</span><br><span class="line">    <span class="function">User <span class="title">selectById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select</span>(&#123;<span class="string">"select "</span>, SELECT_FIELDS, <span class="string">" from "</span>, TABLE_NAME, <span class="string">" where name=#&#123;name&#125;"</span>&#125;)</span><br><span class="line">    <span class="function">User <span class="title">selectByName</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span>(&#123;<span class="string">"update "</span>, TABLE_NAME, <span class="string">" set password=#&#123;password&#125; where id=#&#123;id&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updatePassword</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete</span>(&#123;<span class="string">"delete from "</span>, TABLE_NAME, <span class="string">" where id=#&#123;id&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="6-interceptor"><a href="#6-interceptor" class="headerlink" title="6. interceptor"></a>6. interceptor</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/78863910.jpg" alt="interceptor"></p>
<h2 id="6-1-LoginRequiredInterceptor"><a href="#6-1-LoginRequiredInterceptor" class="headerlink" title="6.1 LoginRequiredInterceptor"></a>6.1 LoginRequiredInterceptor</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginRequiredInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hostHolder.getUser() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            httpServletResponse.sendRedirect(<span class="string">"/?pop=1"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-拦截器-Interceptor"><a href="#1-拦截器-Interceptor" class="headerlink" title="1)拦截器(Interceptor)"></a>1)拦截器(Interceptor)</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>在Web开发中，拦截器(Interceptor)可以用来<code>验证是否登录</code>、<code>预先设置数据</code>以及<code>统计方法的执行效率</code>等。</p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>Spring中的拦截器分两种，一是HandlerInterceptor，另一个是MethodInterceptor。这里主要说以下HandlerInterceptor。</p>
<p>HandlerInterceptor是SpringMVC项目中的拦截器，<code>拦截目标是请求的地址</code>，比MethodInterceptor先执行。实现一个HandlerInterceptor拦截器可以直接实现该接口，也可以继承HandlerInterceptorAdapter类。</p>
<h4 id="SpringMVC处理请求过程"><a href="#SpringMVC处理请求过程" class="headerlink" title="SpringMVC处理请求过程"></a>SpringMVC处理请求过程</h4><p>SpringMVC处理请求的整个过程是</p>
<ol>
<li>先根据请求找到对应的<code>HandlerExecutionChain</code>，它包含了处理请求的handler和所有的HandlerInterceptor拦截器</li>
<li>然后在调用hander之前分别调用<code>每个HandlerInterceptor拦截器</code>的<code>preHandle</code>方法<br>2.1 若有一个拦截器返回false，则会调用<code>triggerAfterCompletion</code>方法，并且立即返回不再往下执行<br>2.2 若所有的拦截器全部返回true并且没有出现异常，则<code>调用handler返回ModelAndView对象</code>；再然后分别调用每个拦截器的<code>postHandle</code>方法；最后，即使是之前的步骤抛出了异常，也会执行<code>triggerAfterCompletion</code>方法。</li>
</ol>
<p><strong>多拦截器工作流程：</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/11861611-46328f0891f5eda3?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="多拦截器工作流程"></p>
<h4 id="需要Override的三种方法"><a href="#需要Override的三种方法" class="headerlink" title="需要Override的三种方法"></a>需要Override的三种方法</h4><p>（1 ）<code>preHandle (HttpServletRequest request, HttpServletResponse response, Object handle)</code><br><strong>controller 执行之前调用</strong><br>该方法将在请求处理之前进行调用。SpringMVC 中的Interceptor 是链式调用的，在一个请求中可以同时存在多个Interceptor 。每个Interceptor 的调用会依据它的声明顺序依次执行，而且最先执行的都是Interceptor 中的preHandle 方法，所以可以在这个方法中进行一些前置初始化操作或者是对当前请求的一个预处理，也可以在这个方法中进行一些判断来决定请求是否要继续进行下去。该方法的返回值是布尔值Boolean 类型的，当它返回为false 时，表示请求结束，后续的Interceptor 和Controller 都不会再执行；当返回值为true 时就会继续调用下一个Interceptor 的preHandle 方法，如果已经是最后一个Interceptor 的时候就会是调用当前请求的Controller 方法。<br>（2 ）<code>postHandle (HttpServletRequest request, HttpServletResponse response, Object handle, ModelAndView modelAndView)</code><br><strong>controller 执行之后，且页面渲染之前调用</strong><br>这个方法包括后面要说到的afterCompletion 方法都只能是在当前所属的Interceptor 的preHandle 方法的返回值为true 时才能被调用。postHandle 方法，是在当前请求进行处理之后，也就是Controller 方法调用之后执行，但是它会在DispatcherServlet 进行视图渲染之前被调用，所以我们可以在这个方法中对Controller 处理之后的ModelAndView 对象进行操作。postHandle 方法被调用的方向跟preHandle 是相反的，也就是说先声明的Interceptor 的postHandle 方法反而会后执行。<br>（3 ）<code>afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handle, Exception ex)</code><br><strong>页面渲染之后调用，一般用于资源清理操作。</strong><br>该方法也是需要当前对应的Interceptor 的preHandle 方法的返回值为true 时才会执行。该方法将在整个请求结束之后，也就是在DispatcherServlet 渲染了对应的视图之后执行。这个方法的主要作用是用于进行资源清理工作的。</p>
<h4 id="在Spring-Boot中配置拦截器，需要写一个配置类继承WebMvcConfigurerAdapter类并添加该拦截器-见2"><a href="#在Spring-Boot中配置拦截器，需要写一个配置类继承WebMvcConfigurerAdapter类并添加该拦截器-见2" class="headerlink" title="在Spring Boot中配置拦截器，需要写一个配置类继承WebMvcConfigurerAdapter类并添加该拦截器(见2)"></a>在Spring Boot中配置拦截器，需要写一个配置类<code>继承WebMvcConfigurerAdapter</code>类并添加该拦截器(见2)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class XdtoutiaoWebConfiguration extends WebMvcConfigurerAdapter &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    PassportInterceptor passportInterceptor;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public void addInterceptors(InterceptorRegistry registry) &#123;</span><br><span class="line">        registry.addInterceptor(passportInterceptor);</span><br><span class="line">        super.addInterceptors(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-PassportInterceptor"><a href="#6-2-PassportInterceptor" class="headerlink" title="6.2 PassportInterceptor"></a>6.2 PassportInterceptor</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PassportInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginTicketDAO loginTicketDAO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDAO userDAO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String ticket = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (httpServletRequest.getCookies() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Cookie cookie : httpServletRequest.getCookies()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cookie.getName().equals(<span class="string">"ticket"</span>)) &#123;</span><br><span class="line">                    ticket = cookie.getValue();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ticket != <span class="keyword">null</span>) &#123;</span><br><span class="line">            LoginTicket loginTicket = loginTicketDAO.selectByTicket(ticket);</span><br><span class="line">            <span class="keyword">if</span> (loginTicket == <span class="keyword">null</span> || loginTicket.getExpired().before(<span class="keyword">new</span> Date()) || loginTicket.getStatus() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            User user = userDAO.selectById(loginTicket.getUserId());</span><br><span class="line">            hostHolder.setUser(user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (modelAndView != <span class="keyword">null</span> &amp;&amp; hostHolder.getUser() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            modelAndView.addObject(<span class="string">"user"</span>, hostHolder.getUser());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        hostHolder.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="7-model"><a href="#7-model" class="headerlink" title="7. model"></a>7. model</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/69983327.jpg" alt="model"></p>
<h2 id="7-1-Comment"><a href="#7-1-Comment" class="headerlink" title="7.1 Comment"></a>7.1 Comment</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Comment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> userId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> entityId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> entityType;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> Date createdDate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> status;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getEntityId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> entityId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEntityId</span><span class="params">(<span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.entityId = entityId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getEntityType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> entityType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEntityType</span><span class="params">(<span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.entityType = entityType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreatedDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createdDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreatedDate</span><span class="params">(Date createdDate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createdDate = createdDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatus</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-2-EntityType"><a href="#7-2-EntityType" class="headerlink" title="7.2 EntityType"></a>7.2 EntityType</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntityType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> ENTITY_NEWS = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> ENTITY_COMMENT = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-3-HostHolder"><a href="#7-3-HostHolder" class="headerlink" title="7.3 HostHolder"></a>7.3 HostHolder</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;User&gt; users = <span class="keyword">new</span> ThreadLocal&lt;User&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> users.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        users.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        users.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-4-LoginTicket"><a href="#7-4-LoginTicket" class="headerlink" title="7.4 LoginTicket"></a>7.4 LoginTicket</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginTicket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> userId;</span><br><span class="line">    <span class="keyword">private</span> Date expired;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> status;<span class="comment">// 0有效，1无效</span></span><br><span class="line">    <span class="keyword">private</span> String ticket;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTicket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ticket;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTicket</span><span class="params">(String ticket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ticket = ticket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> expired;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExpired</span><span class="params">(Date expired)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.expired = expired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatus</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-5-Message"><a href="#7-5-Message" class="headerlink" title="7.5 Message"></a>7.5 Message</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fromId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> toId;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> Date createdDate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> hasRead;</span><br><span class="line">    <span class="keyword">private</span> String conversationId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getFromId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fromId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFromId</span><span class="params">(<span class="keyword">int</span> fromId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fromId = fromId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getToId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> toId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setToId</span><span class="params">(<span class="keyword">int</span> toId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.toId = toId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreatedDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createdDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreatedDate</span><span class="params">(Date createdDate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createdDate = createdDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHasRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hasRead;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHasRead</span><span class="params">(<span class="keyword">int</span> hasRead)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hasRead = hasRead;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConversationId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (fromId &lt; toId) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">"%d_%d"</span>, fromId, toId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%d_%d"</span>, toId, fromId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-6-News"><a href="#7-6-News" class="headerlink" title="7.6 News"></a>7.6 News</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">News</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">  <span class="keyword">private</span> String title;</span><br><span class="line">  <span class="keyword">private</span> String link;</span><br><span class="line">  <span class="keyword">private</span> String image;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> likeCount;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> commentCount;</span><br><span class="line">  <span class="keyword">private</span> Date createdDate;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> userId;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> title;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.title = title;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getLink</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> link;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLink</span><span class="params">(String link)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.link = link;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getImage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> image;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImage</span><span class="params">(String image)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.image = image;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLikeCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> likeCount;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLikeCount</span><span class="params">(<span class="keyword">int</span> likeCount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.likeCount = likeCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCommentCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> commentCount;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCommentCount</span><span class="params">(<span class="keyword">int</span> commentCount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.commentCount = commentCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Date <span class="title">getCreatedDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createdDate;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreatedDate</span><span class="params">(Date createdDate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.createdDate = createdDate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userId;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.userId = userId;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-7-User"><a href="#7-7-User" class="headerlink" title="7.7 User"></a>7.7 User</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line">    <span class="keyword">private</span> String headUrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.password = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">this</span>.salt = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">this</span>.headUrl = <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSalt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> salt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSalt</span><span class="params">(String salt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.salt = salt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHeadUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> headUrl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHeadUrl</span><span class="params">(String headUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.headUrl = headUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-8-ViewObject"><a href="#7-8-ViewObject" class="headerlink" title="7.8 ViewObject"></a>7.8 ViewObject</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; objs = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        objs.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> objs.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="8-service"><a href="#8-service" class="headerlink" title="8. service"></a>8. service</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/20611245.jpg" alt="service"></p>
<h2 id="8-1-CommentService"><a href="#8-1-CommentService" class="headerlink" title="8.1 CommentService"></a>8.1 CommentService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentDAO commentDAO;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Comment&gt; <span class="title">getCommentsByEntity</span><span class="params">(<span class="keyword">int</span> entityId, <span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> commentDAO.selectByEntity(entityId, entityType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addComment</span><span class="params">(Comment comment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> commentDAO.addComment(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCommentCount</span><span class="params">(<span class="keyword">int</span> entityId, <span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> commentDAO.getCommentCount(entityId, entityType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteComment</span><span class="params">(<span class="keyword">int</span> entityId, <span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">        commentDAO.updateStatus(entityId, entityType, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-2-LikeService"><a href="#8-2-LikeService" class="headerlink" title="8.2 LikeService"></a>8.2 LikeService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LikeService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JedisAdapter jedisAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLikeStatus</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        String likeKey = RedisKeyUtil.getLikeKey(entityId, entityType);</span><br><span class="line">        <span class="keyword">if</span>(jedisAdapter.sismember(likeKey, String.valueOf(userId))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String disLikeKey = RedisKeyUtil.getDisLikeKey(entityId, entityType);</span><br><span class="line">        <span class="keyword">return</span> jedisAdapter.sismember(disLikeKey, String.valueOf(userId)) ? -<span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">like</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在喜欢集合里增加</span></span><br><span class="line">        String likeKey = RedisKeyUtil.getLikeKey(entityId, entityType);</span><br><span class="line">        jedisAdapter.sadd(likeKey, String.valueOf(userId));</span><br><span class="line">        <span class="comment">// 从反对里删除</span></span><br><span class="line">        String disLikeKey = RedisKeyUtil.getDisLikeKey(entityId, entityType);</span><br><span class="line">        jedisAdapter.srem(disLikeKey, String.valueOf(userId));</span><br><span class="line">        <span class="keyword">return</span> jedisAdapter.scard(likeKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">disLike</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 在反对集合里增加</span></span><br><span class="line">        String disLikeKey = RedisKeyUtil.getDisLikeKey(entityId, entityType);</span><br><span class="line">        jedisAdapter.sadd(disLikeKey, String.valueOf(userId));</span><br><span class="line">        <span class="comment">// 从喜欢里删除</span></span><br><span class="line">        String likeKey = RedisKeyUtil.getLikeKey(entityId, entityType);</span><br><span class="line">        jedisAdapter.srem(likeKey, String.valueOf(userId));</span><br><span class="line">        <span class="keyword">return</span> jedisAdapter.scard(likeKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-3-MessageService"><a href="#8-3-MessageService" class="headerlink" title="8.3 MessageService"></a>8.3 MessageService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MessageDAO messageDAO;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messageDAO.addMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Message&gt; <span class="title">getConversationDetail</span><span class="params">(String conversationId, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messageDAO.getConversationDetail(conversationId, offset, limit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Message&gt; <span class="title">getConversationList</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messageDAO.getConversationList(userId, offset, limit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getConvesationUnreadCount</span><span class="params">(<span class="keyword">int</span> userId, String conversationId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messageDAO.getConvesationUnreadCount(userId, conversationId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-4-NewsService"><a href="#8-4-NewsService" class="headerlink" title="8.4 NewsService"></a>8.4 NewsService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NewsDAO newsDAO;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;News&gt; <span class="title">getLatestNews</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> newsDAO.selectByUserIdAndOffset(userId, offset, limit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addNews</span><span class="params">(News news)</span> </span>&#123;</span><br><span class="line">        newsDAO.addNews(news);</span><br><span class="line">        <span class="keyword">return</span> news.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> News <span class="title">getById</span><span class="params">(<span class="keyword">int</span> newsId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> newsDAO.getById(newsId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">saveImage</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> dotPos = file.getOriginalFilename().lastIndexOf(<span class="string">"."</span>);</span><br><span class="line">        <span class="keyword">if</span> (dotPos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String fileExt = file.getOriginalFilename().substring(dotPos + <span class="number">1</span>).toLowerCase();</span><br><span class="line">        <span class="keyword">if</span> (!ToutiaoUtil.isFileAllowed(fileExt)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String fileName = UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>) + <span class="string">"."</span> + fileExt;</span><br><span class="line">        Files.copy(file.getInputStream(), <span class="keyword">new</span> File(ToutiaoUtil.IMAGE_DIR + fileName).toPath(),</span><br><span class="line">                StandardCopyOption.REPLACE_EXISTING);</span><br><span class="line">        <span class="keyword">return</span> ToutiaoUtil.TOUTIAO_DOMAIN + <span class="string">"image?name="</span> + fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateCommentCount</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> newsDAO.updateCommentCount(id, count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateLikeCount</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> newsDAO.updateLikeCount(id, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-5-QiniuService"><a href="#8-5-QiniuService" class="headerlink" title="8.5 QiniuService"></a>8.5 QiniuService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QiniuService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(QiniuService.class);</span><br><span class="line">    <span class="comment">//设置好账号的ACCESS_KEY和SECRET_KEY</span></span><br><span class="line">    String ACCESS_KEY = <span class="string">"abNXnXBIlI6viRaOeRY6Hk-zc3V-NpjLcGfYz5kD"</span>;</span><br><span class="line">    String SECRET_KEY = <span class="string">"QP7Xja3FmP1Zyl-oxwQDCb7T6wCoEFKoO-0vht_5"</span>;</span><br><span class="line">    <span class="comment">//要上传的空间</span></span><br><span class="line">    String bucketname = <span class="string">"nowcoder"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//密钥配置</span></span><br><span class="line">    Auth auth = Auth.create(ACCESS_KEY, SECRET_KEY);</span><br><span class="line">    <span class="comment">//创建上传对象</span></span><br><span class="line">    UploadManager uploadManager = <span class="keyword">new</span> UploadManager();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String QINIU_IMAGE_DOMAIN = <span class="string">"http://7xsetu.com1.z0.glb.clouddn.com/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//简单上传，使用默认策略，只需要设置上传的空间名就可以了</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUpToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> auth.uploadToken(bucketname);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">saveImage</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> dotPos = file.getOriginalFilename().lastIndexOf(<span class="string">"."</span>);</span><br><span class="line">            <span class="keyword">if</span> (dotPos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String fileExt = file.getOriginalFilename().substring(dotPos + <span class="number">1</span>).toLowerCase();</span><br><span class="line">            <span class="keyword">if</span> (!ToutiaoUtil.isFileAllowed(fileExt)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String fileName = UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>) + <span class="string">"."</span> + fileExt;</span><br><span class="line">            <span class="comment">//调用put方法上传</span></span><br><span class="line">            Response res = uploadManager.put(file.getBytes(), fileName, getUpToken());</span><br><span class="line">            <span class="comment">//打印返回的信息</span></span><br><span class="line">            <span class="keyword">if</span> (res.isOK() &amp;&amp; res.isJson()) &#123;</span><br><span class="line">                <span class="keyword">return</span> QINIU_IMAGE_DOMAIN + JSONObject.parseObject(res.bodyString()).get(<span class="string">"key"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.error(<span class="string">"七牛异常:"</span> + res.bodyString());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (QiniuException e) &#123;</span><br><span class="line">            <span class="comment">// 请求失败时打印的异常的信息</span></span><br><span class="line">            logger.error(<span class="string">"七牛异常:"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-6-ToutiaoService"><a href="#8-6-ToutiaoService" class="headerlink" title="8.6 ToutiaoService"></a>8.6 ToutiaoService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToutiaoService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"This is from ToutiaoService"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8-7-UserService"><a href="#8-7-UserService" class="headerlink" title="8.7 UserService"></a>8.7 UserService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(UserService.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDAO userDAO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginTicketDAO loginTicketDAO;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">register</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(username)) &#123;</span><br><span class="line">            map.put(<span class="string">"msgname"</span>, <span class="string">"用户名不能为空"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(password)) &#123;</span><br><span class="line">            map.put(<span class="string">"msgpwd"</span>, <span class="string">"密码不能为空"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User user = userDAO.selectByName(username);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">            map.put(<span class="string">"msgname"</span>, <span class="string">"用户名已经被注册"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 密码强度</span></span><br><span class="line">        user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setName(username);</span><br><span class="line">        user.setSalt(UUID.randomUUID().toString().substring(<span class="number">0</span>, <span class="number">5</span>));</span><br><span class="line">        String head = String.format(<span class="string">"http://images.nowcoder.com/head/%dt.png"</span>, <span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</span><br><span class="line">        user.setHeadUrl(head);</span><br><span class="line">        user.setPassword(ToutiaoUtil.MD5(password+user.getSalt()));</span><br><span class="line">        userDAO.addUser(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 登陆</span></span><br><span class="line">        String ticket = addLoginTicket(user.getId());</span><br><span class="line">        map.put(<span class="string">"ticket"</span>, ticket);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">login</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(username)) &#123;</span><br><span class="line">            map.put(<span class="string">"msgname"</span>, <span class="string">"用户名不能为空"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(password)) &#123;</span><br><span class="line">            map.put(<span class="string">"msgpwd"</span>, <span class="string">"密码不能为空"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        User user = userDAO.selectByName(username);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            map.put(<span class="string">"msgname"</span>, <span class="string">"用户名不存在"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ToutiaoUtil.MD5(password+user.getSalt()).equals(user.getPassword())) &#123;</span><br><span class="line">            map.put(<span class="string">"msgpwd"</span>, <span class="string">"密码不正确"</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">"userId"</span>, user.getId());</span><br><span class="line"></span><br><span class="line">        String ticket = addLoginTicket(user.getId());</span><br><span class="line">        map.put(<span class="string">"ticket"</span>, ticket);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">addLoginTicket</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        LoginTicket ticket = <span class="keyword">new</span> LoginTicket();</span><br><span class="line">        ticket.setUserId(userId);</span><br><span class="line">        Date date = <span class="keyword">new</span> Date();</span><br><span class="line">        date.setTime(date.getTime() + <span class="number">1000</span>*<span class="number">3600</span>*<span class="number">24</span>);</span><br><span class="line">        ticket.setExpired(date);</span><br><span class="line">        ticket.setStatus(<span class="number">0</span>);</span><br><span class="line">        ticket.setTicket(UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>));</span><br><span class="line">        loginTicketDAO.addTicket(ticket);</span><br><span class="line">        <span class="keyword">return</span> ticket.getTicket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDAO.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">(String ticket)</span> </span>&#123;</span><br><span class="line">        loginTicketDAO.updateStatus(ticket, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="9-util"><a href="#9-util" class="headerlink" title="9. util"></a>9. util</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/48084756.jpg" alt="util"></p>
<h2 id="9-1-JedisAdapter"><a href="#9-1-JedisAdapter" class="headerlink" title="9.1 JedisAdapter"></a>9.1 JedisAdapter</h2><p>利用JSON进行对象序列化和反序列化，JSON存到Redis中，可以做在在Redis中存储对象。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//将一个对象转换为一个jsoon串存入set中</span><br><span class="line">public void setObject(String key, Object obj) &#123;</span><br><span class="line">        set(key, JSON.toJSONString(obj));</span><br><span class="line">&#125;</span><br><span class="line">//从set中取出json串，并转换为相应object</span><br><span class="line">public &lt;T&gt; T getObject(String key, Class&lt;T&gt; clazz) &#123;</span><br><span class="line">        String value = get(key);</span><br><span class="line">        if (value != null) &#123;</span><br><span class="line">            return JSON.parseObject(value, clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       User user = <span class="keyword">new</span> User();</span><br><span class="line">       user.setHeadUrl(<span class="string">"http://images.nowcoder.com/head/100t.png"</span>);</span><br><span class="line">       user.setName(<span class="string">"user1"</span>);</span><br><span class="line">       user.setPassword(<span class="string">"abc"</span>);</span><br><span class="line">       user.setSalt(<span class="string">"def"</span>);</span><br><span class="line">       jedisAdapter.setObject(<span class="string">"user1"</span>, user);</span><br><span class="line"></span><br><span class="line">       User u = jedisAdapter.getObject(<span class="string">"user1"</span>, User.class);</span><br><span class="line">       System.out.print(ToStringBuilder.reflectionToString(u));  <span class="comment">//反序列化</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisAdapter</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(JedisAdapter.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> index, Object obj)</span> </span>&#123;</span><br><span class="line">        System.out.println(String.format(<span class="string">"%d,%s"</span>, index, obj.toString()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mainx</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis();</span><br><span class="line">        jedis.flushAll();</span><br><span class="line">        <span class="comment">// get,set</span></span><br><span class="line">        jedis.set(<span class="string">"hello"</span>, <span class="string">"world"</span>);</span><br><span class="line">        print(<span class="number">1</span>, jedis.get(<span class="string">"hello"</span>));</span><br><span class="line">        jedis.rename(<span class="string">"hello"</span>, <span class="string">"newhello"</span>);</span><br><span class="line">        print(<span class="number">1</span>, jedis.get(<span class="string">"newhello"</span>));</span><br><span class="line">        jedis.setex(<span class="string">"hello2"</span>, <span class="number">15</span>, <span class="string">"world"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数值操作</span></span><br><span class="line">        jedis.set(<span class="string">"pv"</span>, <span class="string">"100"</span>);</span><br><span class="line">        jedis.incr(<span class="string">"pv"</span>);</span><br><span class="line">        jedis.decrBy(<span class="string">"pv"</span>, <span class="number">5</span>);</span><br><span class="line">        print(<span class="number">2</span>, jedis.get(<span class="string">"pv"</span>));</span><br><span class="line">        print(<span class="number">3</span>, jedis.keys(<span class="string">"*"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 列表操作, 最近来访, 粉丝列表，消息队列</span></span><br><span class="line">        String listName = <span class="string">"list"</span>;</span><br><span class="line">        jedis.del(listName);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            jedis.lpush(listName, <span class="string">"a"</span> + String.valueOf(i));</span><br><span class="line">        &#125;</span><br><span class="line">        print(<span class="number">4</span>, jedis.lrange(listName, <span class="number">0</span>, <span class="number">12</span>)); <span class="comment">// 最近来访10个id</span></span><br><span class="line">        print(<span class="number">5</span>, jedis.llen(listName));</span><br><span class="line">        print(<span class="number">6</span>, jedis.lpop(listName));</span><br><span class="line">        print(<span class="number">7</span>, jedis.llen(listName));</span><br><span class="line">        print(<span class="number">8</span>, jedis.lrange(listName, <span class="number">2</span>, <span class="number">6</span>)); <span class="comment">// 最近来访10个id</span></span><br><span class="line">        print(<span class="number">9</span>, jedis.lindex(listName, <span class="number">3</span>));</span><br><span class="line">        print(<span class="number">10</span>, jedis.linsert(listName, BinaryClient.LIST_POSITION.AFTER, <span class="string">"a4"</span>, <span class="string">"xx"</span>));</span><br><span class="line">        print(<span class="number">10</span>, jedis.linsert(listName, BinaryClient.LIST_POSITION.BEFORE, <span class="string">"a4"</span>, <span class="string">"bb"</span>));</span><br><span class="line">        print(<span class="number">11</span>, jedis.lrange(listName, <span class="number">0</span>, <span class="number">12</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// hash, 可变字段</span></span><br><span class="line">        String userKey = <span class="string">"userxx"</span>;</span><br><span class="line">        jedis.hset(userKey, <span class="string">"name"</span>, <span class="string">"jim"</span>);</span><br><span class="line">        jedis.hset(userKey, <span class="string">"age"</span>, <span class="string">"12"</span>);</span><br><span class="line">        jedis.hset(userKey, <span class="string">"phone"</span>, <span class="string">"18666666666"</span>);</span><br><span class="line">        print(<span class="number">12</span>, jedis.hget(userKey, <span class="string">"name"</span>));</span><br><span class="line">        print(<span class="number">13</span>, jedis.hgetAll(userKey));</span><br><span class="line">        jedis.hdel(userKey, <span class="string">"phone"</span>);</span><br><span class="line">        print(<span class="number">14</span>, jedis.hgetAll(userKey));</span><br><span class="line">        print(<span class="number">15</span>, jedis.hexists(userKey, <span class="string">"email"</span>));</span><br><span class="line">        print(<span class="number">16</span>, jedis.hexists(userKey, <span class="string">"age"</span>));</span><br><span class="line">        print(<span class="number">17</span>, jedis.hkeys(userKey));</span><br><span class="line">        print(<span class="number">18</span>, jedis.hvals(userKey));</span><br><span class="line">        jedis.hsetnx(userKey, <span class="string">"school"</span>, <span class="string">"zju"</span>);</span><br><span class="line">        jedis.hsetnx(userKey, <span class="string">"name"</span>, <span class="string">"yxy"</span>);</span><br><span class="line">        print(<span class="number">19</span>, jedis.hgetAll(userKey));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 集合，点赞用户群, 共同好友</span></span><br><span class="line">        String likeKey1 = <span class="string">"newsLike1"</span>;</span><br><span class="line">        String likeKey2 = <span class="string">"newsLike2"</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            jedis.sadd(likeKey1, String.valueOf(i));</span><br><span class="line">            jedis.sadd(likeKey2, String.valueOf(i * <span class="number">2</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        print(<span class="number">20</span>, jedis.smembers(likeKey1));</span><br><span class="line">        print(<span class="number">21</span>, jedis.smembers(likeKey2));</span><br><span class="line">        print(<span class="number">22</span>, jedis.sunion(likeKey1, likeKey2));</span><br><span class="line">        print(<span class="number">23</span>, jedis.sdiff(likeKey1, likeKey2));</span><br><span class="line">        print(<span class="number">24</span>, jedis.sinter(likeKey1, likeKey2));</span><br><span class="line">        print(<span class="number">25</span>, jedis.sismember(likeKey1, <span class="string">"12"</span>));</span><br><span class="line">        print(<span class="number">26</span>, jedis.sismember(likeKey2, <span class="string">"12"</span>));</span><br><span class="line">        jedis.srem(likeKey1, <span class="string">"5"</span>);</span><br><span class="line">        print(<span class="number">27</span>, jedis.smembers(likeKey1));</span><br><span class="line">        <span class="comment">// 从1移动到2</span></span><br><span class="line">        jedis.smove(likeKey2, likeKey1, <span class="string">"14"</span>);</span><br><span class="line">        print(<span class="number">28</span>, jedis.smembers(likeKey1));</span><br><span class="line">        print(<span class="number">29</span>, jedis.scard(likeKey1));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 排序集合，有限队列，排行榜</span></span><br><span class="line">        String rankKey = <span class="string">"rankKey"</span>;</span><br><span class="line">        jedis.zadd(rankKey, <span class="number">15</span>, <span class="string">"Jim"</span>);</span><br><span class="line">        jedis.zadd(rankKey, <span class="number">60</span>, <span class="string">"Ben"</span>);</span><br><span class="line">        jedis.zadd(rankKey, <span class="number">90</span>, <span class="string">"Lee"</span>);</span><br><span class="line">        jedis.zadd(rankKey, <span class="number">75</span>, <span class="string">"Lucy"</span>);</span><br><span class="line">        jedis.zadd(rankKey, <span class="number">80</span>, <span class="string">"Mei"</span>);</span><br><span class="line">        print(<span class="number">30</span>, jedis.zcard(rankKey));</span><br><span class="line">        print(<span class="number">31</span>, jedis.zcount(rankKey, <span class="number">61</span>, <span class="number">100</span>));</span><br><span class="line">        <span class="comment">// 改错卷了</span></span><br><span class="line">        print(<span class="number">32</span>, jedis.zscore(rankKey, <span class="string">"Lucy"</span>));</span><br><span class="line">        jedis.zincrby(rankKey, <span class="number">2</span>, <span class="string">"Lucy"</span>);</span><br><span class="line">        print(<span class="number">33</span>, jedis.zscore(rankKey, <span class="string">"Lucy"</span>));</span><br><span class="line">        jedis.zincrby(rankKey, <span class="number">2</span>, <span class="string">"Luc"</span>);</span><br><span class="line">        print(<span class="number">34</span>, jedis.zscore(rankKey, <span class="string">"Luc"</span>));</span><br><span class="line">        print(<span class="number">35</span>, jedis.zcount(rankKey, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        <span class="comment">// 1-4 名 Luc</span></span><br><span class="line">        print(<span class="number">36</span>, jedis.zrange(rankKey, <span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        print(<span class="number">36</span>, jedis.zrange(rankKey, <span class="number">1</span>, <span class="number">3</span>));</span><br><span class="line">        print(<span class="number">36</span>, jedis.zrevrange(rankKey, <span class="number">1</span>, <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">for</span> (Tuple tuple : jedis.zrangeByScoreWithScores(rankKey, <span class="string">"60"</span>, <span class="string">"100"</span>)) &#123;</span><br><span class="line">            print(<span class="number">37</span>, tuple.getElement() + <span class="string">":"</span> + String.valueOf(tuple.getScore()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        print(<span class="number">38</span>, jedis.zrank(rankKey, <span class="string">"Ben"</span>));</span><br><span class="line">        print(<span class="number">39</span>, jedis.zrevrank(rankKey, <span class="string">"Ben"</span>));</span><br><span class="line"></span><br><span class="line">        String setKey = <span class="string">"zset"</span>;</span><br><span class="line">        jedis.zadd(setKey, <span class="number">1</span>, <span class="string">"a"</span>);</span><br><span class="line">        jedis.zadd(setKey, <span class="number">1</span>, <span class="string">"b"</span>);</span><br><span class="line">        jedis.zadd(setKey, <span class="number">1</span>, <span class="string">"c"</span>);</span><br><span class="line">        jedis.zadd(setKey, <span class="number">1</span>, <span class="string">"d"</span>);</span><br><span class="line">        jedis.zadd(setKey, <span class="number">1</span>, <span class="string">"e"</span>);</span><br><span class="line">        print(<span class="number">40</span>, jedis.zlexcount(setKey, <span class="string">"-"</span>, <span class="string">"+"</span>));</span><br><span class="line">        print(<span class="number">41</span>, jedis.zlexcount(setKey, <span class="string">"(b"</span>, <span class="string">"[d"</span>));</span><br><span class="line">        print(<span class="number">42</span>, jedis.zlexcount(setKey, <span class="string">"[b"</span>, <span class="string">"[d"</span>));</span><br><span class="line">        jedis.zrem(setKey, <span class="string">"b"</span>);</span><br><span class="line">        print(<span class="number">43</span>, jedis.zrange(setKey, <span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        jedis.zremrangeByLex(setKey, <span class="string">"(c"</span>, <span class="string">"+"</span>);</span><br><span class="line">        print(<span class="number">44</span>, jedis.zrange(setKey, <span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        jedis.lpush("aaa", "A");</span></span><br><span class="line"><span class="comment">        jedis.lpush("aaa", "B");</span></span><br><span class="line"><span class="comment">        jedis.lpush("aaa", "C");</span></span><br><span class="line"><span class="comment">        print(45, jedis.brpop(0, "aaa"));</span></span><br><span class="line"><span class="comment">        print(45, jedis.brpop(0, "aaa"));</span></span><br><span class="line"><span class="comment">        print(45, jedis.brpop(0, "aaa"));</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        JedisPool pool = <span class="keyword">new</span> JedisPool();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) &#123;</span><br><span class="line">            Jedis j = pool.getResource();</span><br><span class="line">            j.get(<span class="string">"a"</span>);</span><br><span class="line">            j.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> JedisPool pool = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//jedis = new Jedis("localhost");</span></span><br><span class="line">        pool = <span class="keyword">new</span> JedisPool(<span class="string">"localhost"</span>, <span class="number">6379</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.get(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            jedis.set(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sadd</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.sadd(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">srem</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.srem(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sismember</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.sismember(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">scard</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.scard(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setex</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 验证码, 防机器注册，记录上次注册时间，有效期3天</span></span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            jedis.setex(key, <span class="number">10</span>, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lpush</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.lpush(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">brpop</span><span class="params">(<span class="keyword">int</span> timeout, String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = pool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.brpop(timeout, key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发生异常"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObject</span><span class="params">(String key, Object obj)</span> </span>&#123;</span><br><span class="line">        set(key, JSON.toJSONString(obj));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getObject</span><span class="params">(String key, Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        String value = get(key);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSON.parseObject(value, clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-2-MailSender"><a href="#9-2-MailSender" class="headerlink" title="9.2 MailSender"></a>9.2 MailSender</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailSender</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MailSender.class);</span><br><span class="line">    <span class="keyword">private</span> JavaMailSenderImpl mailSender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VelocityEngine velocityEngine;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendWithHTMLTemplate</span><span class="params">(String to, String subject,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        String template, Map&lt;String, Object&gt; model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String nick = MimeUtility.encodeText(<span class="string">"牛客中级课"</span>);</span><br><span class="line">            InternetAddress from = <span class="keyword">new</span> InternetAddress(nick + <span class="string">"&lt;course@nowcoder.com&gt;"</span>);</span><br><span class="line">            MimeMessage mimeMessage = mailSender.createMimeMessage();</span><br><span class="line">            MimeMessageHelper mimeMessageHelper = <span class="keyword">new</span> MimeMessageHelper(mimeMessage);</span><br><span class="line">            String result = VelocityEngineUtils</span><br><span class="line">                    .mergeTemplateIntoString(velocityEngine, template, <span class="string">"UTF-8"</span>, model);</span><br><span class="line">            mimeMessageHelper.setTo(to);</span><br><span class="line">            mimeMessageHelper.setFrom(from);</span><br><span class="line">            mimeMessageHelper.setSubject(subject);</span><br><span class="line">            mimeMessageHelper.setText(result, <span class="keyword">true</span>);</span><br><span class="line">            mailSender.send(mimeMessage);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"发送邮件失败"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mailSender = <span class="keyword">new</span> JavaMailSenderImpl();</span><br><span class="line">        mailSender.setUsername(<span class="string">"course@nowcoder.com"</span>);</span><br><span class="line">        mailSender.setPassword(<span class="string">"NKnk66"</span>);</span><br><span class="line">        mailSender.setHost(<span class="string">"smtp.exmail.qq.com"</span>);</span><br><span class="line">        mailSender.setPort(<span class="number">465</span>);</span><br><span class="line">        mailSender.setProtocol(<span class="string">"smtps"</span>);</span><br><span class="line">        mailSender.setDefaultEncoding(<span class="string">"utf8"</span>);</span><br><span class="line">        Properties javaMailProperties = <span class="keyword">new</span> Properties();</span><br><span class="line">        javaMailProperties.put(<span class="string">"mail.smtp.ssl.enable"</span>, <span class="keyword">true</span>);</span><br><span class="line">        mailSender.setJavaMailProperties(javaMailProperties);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-3-RedisKeyUtil"><a href="#9-3-RedisKeyUtil" class="headerlink" title="9.3 RedisKeyUtil"></a>9.3 RedisKeyUtil</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisKeyUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String SPLIT = <span class="string">":"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String BIZ_LIKE = <span class="string">"LIKE"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String BIZ_DISLIKE = <span class="string">"DISLIKE"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String BIZ_EVENT = <span class="string">"EVENT"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getEventQueueKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BIZ_EVENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getLikeKey</span><span class="params">(<span class="keyword">int</span> entityId, <span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BIZ_LIKE + SPLIT + String.valueOf(entityType) + SPLIT + String.valueOf(entityId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDisLikeKey</span><span class="params">(<span class="keyword">int</span> entityId, <span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BIZ_DISLIKE + SPLIT + String.valueOf(entityType) + SPLIT + String.valueOf(entityId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-4-ToutiaoUtil"><a href="#9-4-ToutiaoUtil" class="headerlink" title="9.4 ToutiaoUtil"></a>9.4 ToutiaoUtil</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToutiaoUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ToutiaoUtil.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String TOUTIAO_DOMAIN = <span class="string">"http://127.0.0.1:8080/"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String IMAGE_DIR = <span class="string">"D:/upload/"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] IMAGE_FILE_EXTD = <span class="keyword">new</span> String[] &#123;<span class="string">"png"</span>, <span class="string">"bmp"</span>, <span class="string">"jpg"</span>, <span class="string">"jpeg"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isFileAllowed</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String ext : IMAGE_FILE_EXTD) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ext.equals(fileName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJSONString</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        json.put(<span class="string">"code"</span>, code);</span><br><span class="line">        <span class="keyword">return</span> json.toJSONString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJSONString</span><span class="params">(<span class="keyword">int</span> code, String msg)</span> </span>&#123;</span><br><span class="line">        JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        json.put(<span class="string">"code"</span>, code);</span><br><span class="line">        json.put(<span class="string">"msg"</span>, msg);</span><br><span class="line">        <span class="keyword">return</span> json.toJSONString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJSONString</span><span class="params">(<span class="keyword">int</span> code, Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">        JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        json.put(<span class="string">"code"</span>, code);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) &#123;</span><br><span class="line">            json.put(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> json.toJSONString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">MD5</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> hexDigits[] = &#123;</span><br><span class="line">                <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] btInput = key.getBytes();</span><br><span class="line">            <span class="comment">// 获得MD5摘要算法的 MessageDigest 对象</span></span><br><span class="line">            MessageDigest mdInst = MessageDigest.getInstance(<span class="string">"MD5"</span>);</span><br><span class="line">            <span class="comment">// 使用指定的字节更新摘要</span></span><br><span class="line">            mdInst.update(btInput);</span><br><span class="line">            <span class="comment">// 获得密文</span></span><br><span class="line">            <span class="keyword">byte</span>[] md = mdInst.digest();</span><br><span class="line">            <span class="comment">// 把密文转换成十六进制的字符串形式</span></span><br><span class="line">            <span class="keyword">int</span> j = md.length;</span><br><span class="line">            <span class="keyword">char</span> str[] = <span class="keyword">new</span> <span class="keyword">char</span>[j * <span class="number">2</span>];</span><br><span class="line">            <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; j; i++) &#123;</span><br><span class="line">                <span class="keyword">byte</span> byte0 = md[i];</span><br><span class="line">                str[k++] = hexDigits[byte0 &gt;&gt;&gt; <span class="number">4</span> &amp; <span class="number">0xf</span>];</span><br><span class="line">                str[k++] = hexDigits[byte0 &amp; <span class="number">0xf</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(str);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"生成MD5失败"</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="10-ToutiaoApplication"><a href="#10-ToutiaoApplication" class="headerlink" title="10. ToutiaoApplication"></a>10. ToutiaoApplication</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToutiaoApplication</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(ToutiaoApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ToutiaoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="spring-的SpringApplication"><a href="#spring-的SpringApplication" class="headerlink" title="spring 的SpringApplication"></a>spring 的SpringApplication</h3><h4 id="作用：入口类"><a href="#作用：入口类" class="headerlink" title="作用：入口类"></a>作用：入口类</h4><p>Spring应用的入口类是Spring应用的配置起点，是配置Spring上下文的起点，往往使用了<code>@SpringBootApplication</code>或@<code>EnableAutoConfiguration</code>等标注类。</p>
<p>在Spring应用的入口类中往往只有一个main()方法，这虽然与标准的Java应用保持了一致，但在有些时候会让开发人员觉得困惑。</p>
<p>在Spring应用的入口类中的main()方法中，往往只是简单地调用Spring Boot的SpringApplication类的<code>run()</code>方法，以启动该Spring应用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpringApplication.run(MySpringConfigurationApp.class, args);</span><br></pre></td></tr></table></figure>
<h3 id="Spring-Boot的SpringApplication类"><a href="#Spring-Boot的SpringApplication类" class="headerlink" title="Spring Boot的SpringApplication类"></a>Spring Boot的SpringApplication类</h3><p>Spring Boot的SpringApplication类，用以<code>启动一个Spring应用</code>，实质上是为Spring应用<code>创建并初始化Spring上下文</code>。</p>
<p>SpringApplication类的<code>run()</code>方法默认返回一个ConfigurableApplicationContext对象。</p>
<h1 id="11-配置文件及模板"><a href="#11-配置文件及模板" class="headerlink" title="11. 配置文件及模板"></a>11. 配置文件及模板</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/63511127.jpg" alt="配置文件及模板"></p>
<h2 id="11-1-NewsDAO-xml"><a href="#11-1-NewsDAO-xml" class="headerlink" title="11.1 NewsDAO.xml"></a>11.1 NewsDAO.xml</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.nowcoder.dao.NewsDAO&quot;&gt;</span><br><span class="line">    &lt;sql id=&quot;table&quot;&gt;news&lt;/sql&gt;</span><br><span class="line">    &lt;sql id=&quot;selectFields&quot;&gt;id,title, link, image, like_count, comment_count,created_date,user_id</span><br><span class="line">    &lt;/sql&gt;</span><br><span class="line">    &lt;select id=&quot;selectByUserIdAndOffset&quot; resultType=&quot;com.nowcoder.model.News&quot;&gt;</span><br><span class="line">        SELECT</span><br><span class="line">        &lt;include refid=&quot;selectFields&quot;/&gt;</span><br><span class="line">        FROM</span><br><span class="line">        &lt;include refid=&quot;table&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;if test=&quot;userId != 0&quot;&gt;</span><br><span class="line">            WHERE user_id = #&#123;userId&#125;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        ORDER BY id DESC</span><br><span class="line">        LIMIT #&#123;offset&#125;,#&#123;limit&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
<h3 id="MyBatis的Mapper-XML-文件"><a href="#MyBatis的Mapper-XML-文件" class="headerlink" title="MyBatis的Mapper XML 文件"></a>MyBatis的Mapper XML 文件</h3><p>MyBatis 的真正强大在于它的映射语句，也是它的魔力所在。</p>
<p>详细请见<a href="http://www.mybatis.org/mybatis-3/zh/sqlmap-xml.html" target="_blank" rel="noopener">官方文档</a></p>
<h4 id="SQL-映射顶级元素（按照它们应该被定义的顺序）"><a href="#SQL-映射顶级元素（按照它们应该被定义的顺序）" class="headerlink" title="SQL 映射顶级元素（按照它们应该被定义的顺序）"></a>SQL 映射顶级元素（按照它们应该被定义的顺序）</h4><p>cache – 给定命名空间的缓存配置<br>cache-ref – 其他命名空间缓存配置的引用<br>resultMap – 是最复杂也是最强大的元素，用来描述如何从数据库结果集中来加载对象<br>sql – 可被其他语句引用的可重用语句块<br>insert – 映射插入语句<br>update – 映射更新语句<br>delete – 映射删除语句<br>select – 映射查询语句</p>
<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>在命名空间中唯一的标识符，可以被用来引用这条语句</td>
</tr>
<tr>
<td>parameterType</td>
<td>将会传入这条语句的参数类的完全限定名或别名。这个属性是可选的，因为 MyBatis 可以通过 TypeHandler 推断出具体传入语句的参数，默认值为 unset</td>
</tr>
<tr>
<td>parameterMap</td>
<td>这是引用外部 parameterMap 的已经被废弃的方法。使用内联参数映射和 parameterType 属性</td>
</tr>
<tr>
<td>resultType</td>
<td>从这条语句中返回的期望类型的类的完全限定名或别名。注意如果是集合情形，那应该是集合可以包含的类型，而不能是集合本身。使用 resultType 或 resultMap，但不能同时使用</td>
</tr>
</tbody>
</table>
<h2 id="11-2-application-properties"><a href="#11-2-application-properties" class="headerlink" title="11.2 application.properties"></a>11.2 application.properties</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/toutiao?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=nowcoder</span><br><span class="line">mybatis.config-location=classpath:mybatis-config.xml</span><br><span class="line">#logging.level.root=DEBUG</span><br><span class="line">spring.velocity.suffix=.html</span><br><span class="line">spring.velocity.cache=false</span><br><span class="line">spring.velocity.toolbox-config-location=toolbox.xml</span><br></pre></td></tr></table></figure>
<h2 id="11-3-mybatis-config-xml"><a href="#11-3-mybatis-config-xml" class="headerlink" title="11.3  mybatis-config.xml"></a>11.3  mybatis-config.xml</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line"></span><br><span class="line">    &lt;settings&gt;</span><br><span class="line">        &lt;!-- Globally enables or disables any caches configured in any mapper under this configuration --&gt;</span><br><span class="line">        &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- Sets the number of seconds the driver will wait for a response from the database --&gt;</span><br><span class="line">        &lt;setting name=&quot;defaultStatementTimeout&quot; value=&quot;3000&quot;/&gt;</span><br><span class="line">        &lt;!-- Enables automatic mapping from classic database column names A_COLUMN to camel case classic Java property names aColumn --&gt;</span><br><span class="line">        &lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- Allows JDBC support for generated keys. A compatible driver is required.</span><br><span class="line">        This setting forces generated keys to be used if set to true,</span><br><span class="line">         as some drivers deny compatibility but still work --&gt;</span><br><span class="line">        &lt;setting name=&quot;useGeneratedKeys&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">    &lt;/settings&gt;</span><br><span class="line">    &lt;!-- Continue going here --&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<h2 id="11-4-toolbox-xml"><a href="#11-4-toolbox-xml" class="headerlink" title="11.4 toolbox.xml"></a>11.4 toolbox.xml</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;toolbox&gt;</span><br><span class="line">    &lt;tool&gt;</span><br><span class="line">    &lt;key&gt;date&lt;/key&gt;</span><br><span class="line">    &lt;scope&gt;application&lt;/scope&gt;</span><br><span class="line">    &lt;class&gt;org.apache.velocity.tools.generic.DateTool&lt;/class&gt;</span><br><span class="line">&lt;/tool&gt;</span><br><span class="line">&lt;/toolbox&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li>velocity-tools 提供了很多实用的 Java 类，使用这些小工具前，需要在 web.xml 中配置 toolbox.xml 文件，在 VelocityViewServlet 后加入另一个参数：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;init-param&gt;</span><br><span class="line">&lt;param-name&gt;org.apache.velocity.toolbox&lt;/param-name&gt;</span><br><span class="line">&lt;param-value&gt;/WEB-INF/toolbox.xml&lt;/param-value&gt;</span><br><span class="line">&lt;/init-param&gt;</span><br></pre></td></tr></table></figure>
<p>这个参数指定了 toolbox.xml 的位置，通常我们把配置文件放在 WEB-INF 下。</p>
<h1 id="12-test"><a href="#12-test" class="headerlink" title="12. test"></a>12. test</h1><p><img src="http://p7vxw6hv7.bkt.clouddn.com/18-7-30/18689521.jpg" alt="test"></p>
<h2 id="12-1-InitDatabaseTests"><a href="#12-1-InitDatabaseTests" class="headerlink" title="12.1 InitDatabaseTests"></a>12.1 InitDatabaseTests</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@SpringApplicationConfiguration(classes = ToutiaoApplication.class)</span><br><span class="line">@Sql(&quot;/init-schema.sql&quot;)</span><br><span class="line">public class InitDatabaseTests &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    UserDAO userDAO;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    NewsDAO newsDAO;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    LoginTicketDAO loginTicketDAO;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    CommentDAO commentDAO;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void initData() &#123;</span><br><span class="line">        Random random = new Random();</span><br><span class="line">        for (int i = 0; i &lt; 11; ++i) &#123;</span><br><span class="line">            User user = new User();</span><br><span class="line">            user.setHeadUrl(String.format(&quot;http://images.nowcoder.com/head/%dt.png&quot;, random.nextInt(1000)));</span><br><span class="line">            user.setName(String.format(&quot;USER%d&quot;, i));</span><br><span class="line">            user.setPassword(&quot;&quot;);</span><br><span class="line">            user.setSalt(&quot;&quot;);</span><br><span class="line">            userDAO.addUser(user);</span><br><span class="line"></span><br><span class="line">            News news = new News();</span><br><span class="line">            news.setCommentCount(i);</span><br><span class="line">            Date date = new Date();</span><br><span class="line">            date.setTime(date.getTime() + 1000*3600*5*i);</span><br><span class="line">            news.setCreatedDate(date);</span><br><span class="line">            news.setImage(String.format(&quot;http://images.nowcoder.com/head/%dm.png&quot;, random.nextInt(1000)));</span><br><span class="line">            news.setLikeCount(i+1);</span><br><span class="line">            news.setUserId(i+1);</span><br><span class="line">            news.setTitle(String.format(&quot;TITLE&#123;%d&#125;&quot;, i));</span><br><span class="line">            news.setLink(String.format(&quot;http://www.nowcoder.com/%d.html&quot;, i));</span><br><span class="line">            newsDAO.addNews(news);</span><br><span class="line"></span><br><span class="line">            for (int j = 0; j &lt; 3; ++j) &#123;</span><br><span class="line">                Comment comment = new Comment();</span><br><span class="line">                comment.setUserId(i+1);</span><br><span class="line">                comment.setEntityId(news.getId());</span><br><span class="line">                comment.setEntityType(EntityType.ENTITY_NEWS);</span><br><span class="line">                comment.setStatus(0);</span><br><span class="line">                comment.setCreatedDate(new Date());</span><br><span class="line">                comment.setContent(&quot;Comment &quot; + String.valueOf(j));</span><br><span class="line">                commentDAO.addComment(comment);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            user.setPassword(&quot;newpassword&quot;);</span><br><span class="line">            userDAO.updatePassword(user);</span><br><span class="line"></span><br><span class="line">            LoginTicket ticket = new LoginTicket();</span><br><span class="line">            ticket.setStatus(0);</span><br><span class="line">            ticket.setUserId(i+1);</span><br><span class="line">            ticket.setExpired(date);</span><br><span class="line">            ticket.setTicket(String.format(&quot;TICKET%d&quot;, i+1));</span><br><span class="line">            loginTicketDAO.addTicket(ticket);</span><br><span class="line"></span><br><span class="line">            loginTicketDAO.updateStatus(ticket.getTicket(), 2);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Assert.assertEquals(&quot;newpassword&quot;, userDAO.selectById(1).getPassword());</span><br><span class="line">        userDAO.deleteById(1);</span><br><span class="line">        Assert.assertNull(userDAO.selectById(1));</span><br><span class="line"></span><br><span class="line">        Assert.assertEquals(1, loginTicketDAO.selectByTicket(&quot;TICKET1&quot;).getUserId());</span><br><span class="line">        Assert.assertEquals(2, loginTicketDAO.selectByTicket(&quot;TICKET1&quot;).getStatus());</span><br><span class="line"></span><br><span class="line">        Assert.assertNotNull(commentDAO.selectByEntity(1, EntityType.ENTITY_NEWS).get(0));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-SpringBoot-Web项目中中如何使用Junit"><a href="#1-SpringBoot-Web项目中中如何使用Junit" class="headerlink" title="1)SpringBoot Web项目中中如何使用Junit"></a>1)SpringBoot Web项目中中如何使用Junit</h3><p>详见<a href="https://blog.csdn.net/catoop/article/details/50752964" target="_blank" rel="noopener">Spring Boot Junit单元测试</a></p>
<ol>
<li>创建一个普通的Java类，在Junit4中不再需要继承TestCase类了</li>
<li>因为我们是Web项目，所以在创建的Java类中添加注解：</li>
</ol>
<table>
<thead>
<tr>
<th>注解</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>@RunWith(SpringJUnit4ClassRunner.class)</td>
<td>SpringJUnit支持，由此引入Spring-Test框架支持</td>
</tr>
<tr>
<td>@SpringApplicationConfiguration(classes = SpringBootSampleApplication.class)</td>
<td>指定我们SpringBoot工程的Application启动类</td>
</tr>
<tr>
<td>@WebAppConfiguration</td>
<td>由于是Web项目，Junit需要模拟ServletContext，因此我们需要给我们的测试类加上@WebAppConfiguration</td>
</tr>
</tbody>
</table>
<ol start="3">
<li>接下来就可以编写测试方法了，测试方法使用@Test注解标注即可。 </li>
</ol>
<h3 id="2-随机数—random-nextInt-1000"><a href="#2-随机数—random-nextInt-1000" class="headerlink" title="2)随机数—random.nextInt(1000)"></a>2)随机数—<code>random.nextInt(1000)</code></h3><p>java中一般有两种随机数，一个是Math中random()方法，一个是Random类。</p>
<p><strong>一、Math.random()</strong></p>
<p>调用Math.Random()函数能够返回<code>带正号的double值</code>，该值大于等于0.0且小于1.0，即取值范围是<code>[0.0,1.0)的左闭右开区间</code></p>
<p><strong>二、Random类</strong></p>
<p>在进行随机时，随机算法的起源数字称为种子数(seed)，在种子数的基础上进行一定的变换，从而产生需要的随机数字。</p>
<p>相同种子数的Random对象，相同次数生成的随机数字是完全相同的。也就是说，两个种子数相同的Random对象，第一次生成的随机数字完全相同，第二次生成的随机数字也完全相同。<br>|Random类中的构造方法|作用|<br>|—|—|<br>|Random random = new Random();|默认构造方法|<br>|Random random = new Random(1000);|指定种子数字|</p>
<p>Random类中各方法生成的随机数字都是均匀分布的，也就是说区间内部的数字生成的几率是均等的。</p>
<table>
<thead>
<tr>
<th>Random类中的常用方法</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>public boolean nextBoolean()</td>
<td>该方法的作用是生成一个随机的boolean值，生成true和false的值几率相等，也就是都是50%的几率</td>
</tr>
<tr>
<td>public double nextDouble()</td>
<td>该方法的作用是生成一个随机的double值，数值介于[0,1.0)之间，这里中括号代表包含区间端点，小括号代表不包含区间端点，也就是0到1之间的随机小数，包含0而不包含1.0</td>
</tr>
<tr>
<td>public int nextInt()</td>
<td>该方法的作用是生成一个随机的int值，该值介于int的区间，也就是-2的31次方到2的31次方-1之间</td>
</tr>
<tr>
<td>public int nextInt(int n)</td>
<td>该方法的作用是生成一个随机的int值，该值介于<code>[0,n)</code>的区间，也就是0到n之间的随机int值，包含0而不包含n</td>
</tr>
<tr>
<td>public void setSeed(long seed)</td>
<td>该方法的作用是重新设置Random对象中的种子数。设置完种子数以后的Random对象和相同种子数使用new关键字创建出的Random对象相同</td>
</tr>
</tbody>
</table>
<h2 id="12-2-JedisTests"><a href="#12-2-JedisTests" class="headerlink" title="12.2 JedisTests"></a>12.2 JedisTests</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@SpringApplicationConfiguration</span>(classes = ToutiaoApplication.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JedisAdapter jedisAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setHeadUrl(<span class="string">"http://image.nowcoder.com/head/100t.png"</span>);</span><br><span class="line">        user.setName(<span class="string">"user1"</span>);</span><br><span class="line">        user.setPassword(<span class="string">"pwd"</span>);;</span><br><span class="line">        user.setSalt(<span class="string">"salt"</span>);</span><br><span class="line"></span><br><span class="line">        jedisAdapter.setObject(<span class="string">"user1xx"</span>, user);</span><br><span class="line"></span><br><span class="line">        User u = jedisAdapter.getObject(<span class="string">"user1xx"</span>, User.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(ToStringBuilder.reflectionToString(u));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-3-LikeServiceTests"><a href="#12-3-LikeServiceTests" class="headerlink" title="12.3  LikeServiceTests"></a>12.3  LikeServiceTests</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@SpringApplicationConfiguration</span>(classes = ToutiaoApplication.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LikeServiceTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LikeService likeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLike</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        likeService.like(<span class="number">123</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        Assert.assertEquals(<span class="number">1</span>, likeService.getLikeStatus(<span class="number">123</span>, <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        likeService.disLike(<span class="number">123</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        Assert.assertEquals(-<span class="number">1</span>, likeService.getLikeStatus(<span class="number">123</span>, <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"B"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span>(expected = IllegalArgumentException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"异常"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"setUp"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"tearDown"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beforeClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"beforeClass"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">afterClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"afterClass"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-4-测试多线程"><a href="#12-4-测试多线程" class="headerlink" title="12.4 测试多线程"></a>12.4 测试多线程</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tid;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(<span class="keyword">int</span> tid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.tid = tid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                System.out.println(String.format(<span class="string">"T%d:%d"</span>, tid, i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;String&gt; q;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;String&gt; q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.q = q;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                q.put(String.valueOf(i));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;String&gt; q;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue&lt;String&gt; q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.q = q;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">":"</span> + q.take());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="comment">//new MyThread(i).start();</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> tid = i;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">                            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                            System.out.println(String.format(<span class="string">"T2%d:%d"</span>, tid, i));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testSynchronized1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(String.format(<span class="string">"T3%d"</span>, i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testSynchronized2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">new</span> Object()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(String.format(<span class="string">"T4%d"</span>, i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testSynchronized</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    testSynchronized1();</span><br><span class="line">                    testSynchronized2();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testBlockingQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BlockingQueue&lt;String&gt; q = <span class="keyword">new</span> ArrayBlockingQueue&lt;String&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Producer(q)).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer(q), <span class="string">"Consumer1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer(q), <span class="string">"Consumer2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> mills)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//Thread.sleep(new Random().nextInt(mills));</span></span><br><span class="line">            Thread.sleep(mills);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testWithAtomic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    sleep(<span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; ++j) &#123;</span><br><span class="line">                        System.out.println(atomicInteger.incrementAndGet());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testWithoutAtomic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    sleep(<span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; ++j) &#123;</span><br><span class="line">                        counter++;</span><br><span class="line">                        System.out.println(counter);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testAtomic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        testWithAtomic();</span><br><span class="line">        testWithoutAtomic();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; threadLocalUserIds = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testThreadLocal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> finalI = i;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    threadLocalUserIds.set(finalI);</span><br><span class="line">                    sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(<span class="string">"ThreadLocal: "</span> + threadLocalUserIds.get());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> finalI = i;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    userId = finalI;</span><br><span class="line">                    sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(<span class="string">"NonThreadLocal: "</span> + userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ExecutorService service = Executors.newSingleThreadExecutor();</span></span><br><span class="line">        ExecutorService service = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">                    sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(<span class="string">"Execute1 "</span> + i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        service.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">                    sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(<span class="string">"Execute2 "</span> + i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        service.shutdown();</span><br><span class="line">        <span class="keyword">while</span> (!service.isTerminated()) &#123;</span><br><span class="line">            sleep(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(<span class="string">"Wait for termination."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testFutrue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ExecutorService service = Executors.newSingleThreadExecutor();</span><br><span class="line">        Future&lt;Integer&gt; future = service.submit(<span class="keyword">new</span> Callable&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                sleep(<span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//throw new IllegalArgumentException("异常");</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        service.shutdown();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//System.out.println(future.get());</span></span><br><span class="line">            System.out.println(future.get(<span class="number">100</span>, TimeUnit.MILLISECONDS));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//testThread();</span></span><br><span class="line">        <span class="comment">//testSynchronized();</span></span><br><span class="line">        <span class="comment">//testBlockingQueue();</span></span><br><span class="line">        <span class="comment">//testAtomic();</span></span><br><span class="line">        <span class="comment">//testThreadLocal();</span></span><br><span class="line">        <span class="comment">//testExecutor();</span></span><br><span class="line">        testFutrue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-5-ToutiaoApplicationTests"><a href="#12-5-ToutiaoApplicationTests" class="headerlink" title="12.5 ToutiaoApplicationTests"></a>12.5 ToutiaoApplicationTests</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@SpringApplicationConfiguration</span>(classes = ToutiaoApplication.class)</span><br><span class="line"><span class="meta">@WebAppConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToutiaoApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12-6-init-schama-sql"><a href="#12-6-init-schama-sql" class="headerlink" title="12.6  init-schama.sql"></a>12.6  init-schama.sql</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `user`;</span><br><span class="line">CREATE TABLE `user` (</span><br><span class="line">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(64) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `password` varchar(128) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `salt` varchar(32) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `head_url` varchar(256) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `name` (`name`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `news`;</span><br><span class="line">CREATE TABLE `news` (</span><br><span class="line">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `title` varchar(128) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `link` varchar(256) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `image` varchar(256) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `like_count` int NOT NULL,</span><br><span class="line">  `comment_count` int NOT NULL,</span><br><span class="line">  `created_date` datetime NOT NULL,</span><br><span class="line">  `user_id` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `login_ticket`;</span><br><span class="line">CREATE TABLE `login_ticket` (</span><br><span class="line">  `id` INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `user_id` INT NOT NULL,</span><br><span class="line">  `ticket` VARCHAR(45) NOT NULL,</span><br><span class="line">  `expired` DATETIME NOT NULL,</span><br><span class="line">  `status` INT NULL DEFAULT 0,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE INDEX `ticket_UNIQUE` (`ticket` ASC)</span><br><span class="line">  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `comment`;</span><br><span class="line">CREATE TABLE `comment` (</span><br><span class="line">`id` INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">`content` TEXT NOT NULL,</span><br><span class="line">`user_id` INT NOT NULL,</span><br><span class="line">`entity_id` INT NOT NULL,</span><br><span class="line">`entity_type` INT NOT NULL,</span><br><span class="line">`created_date` DATETIME NOT NULL,</span><br><span class="line">`status` INT NOT NULL DEFAULT 0,</span><br><span class="line">PRIMARY KEY (`id`),</span><br><span class="line">INDEX `entity_index` (`entity_id` ASC, `entity_type` ASC)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `message`;</span><br><span class="line">CREATE TABLE `message` (</span><br><span class="line">  `id` INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `from_id` INT NULL,</span><br><span class="line">  `to_id` INT NULL,</span><br><span class="line">  `content` TEXT NULL,</span><br><span class="line">  `created_date` DATETIME NULL,</span><br><span class="line">  `has_read` INT NULL,</span><br><span class="line">  `conversation_id` VARCHAR(45) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  INDEX `conversation_index` (`conversation_id` ASC),</span><br><span class="line">  INDEX `created_date` (`created_date` ASC))</span><br><span class="line">ENGINE = InnoDB</span><br><span class="line">DEFAULT CHARACTER SET = utf8;</span><br></pre></td></tr></table></figure>
<p>手动初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">insert  user(name,password,salt,head_url) values(&apos;user1&apos;,&apos;111111&apos;,&apos;&apos;,&apos;http://images.nowcoder.com/head/111t.png&apos;);</span><br><span class="line">insert  user(name,password,salt,head_url) values(&apos;user2&apos;,&apos;222222&apos;,&apos;&apos;,&apos;http://images.nowcoder.com/head/222t.png&apos;);</span><br><span class="line">insert  user(name,password,salt,head_url) values(&apos;user3&apos;,&apos;333333&apos;,&apos;&apos;,&apos;http://images.nowcoder.com/head/333t.png&apos;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert  news(title, link, image, like_count, comment_count, created_date, user_id) values(&apos;TITLE1&apos;,&apos;http://www.nowcoder.com/1.html&apos;,&apos;http://images.nowcoder.com/head/1m.png&apos;,2,1,20180802,1);</span><br><span class="line">insert  news(title, link, image, like_count, comment_count, created_date, user_id) values(&apos;TITLE2&apos;,&apos;http://www.nowcoder.com/2.html&apos;,&apos;http://images.nowcoder.com/head/1m.png&apos;,3,2,20180802,2);</span><br><span class="line">insert  news(title, link, image, like_count, comment_count, created_date, user_id) values(&apos;TITLE3&apos;,&apos;http://www.nowcoder.com/3.html&apos;,&apos;http://images.nowcoder.com/head/1m.png&apos;,1,1,20180802,3);</span><br><span class="line"></span><br><span class="line">insert  login_ticket(user_id, expired, status, ticket) values(1,20180802,0,&quot;TICKET1&quot;);</span><br><span class="line">insert  login_ticket(user_id, expired, status, ticket) values(2,20180802,0,&quot;TICKET2&quot;);</span><br><span class="line">insert  login_ticket(user_id, expired, status, ticket) values(3,20180802,0,&quot;TICKET3&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert  comment(user_id, content, created_date, entity_id, entity_type, status) values(1,&quot;Comment 1~~~&quot;,20180802,1,1,0);</span><br><span class="line">insert  comment(user_id, content, created_date, entity_id, entity_type, status) values(2,&quot;Comment 2~~~&quot;,20180802,2,1,0);</span><br><span class="line">insert  comment(user_id, content, created_date, entity_id, entity_type, status) values(3,&quot;Comment 3~~~&quot;,20180802,3,1,0);</span><br></pre></td></tr></table></figure>
<p>手动初始化toutiao2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `user`;</span><br><span class="line">CREATE TABLE `user` (</span><br><span class="line">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(64) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `password` varchar(128) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `salt` varchar(32) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `head_url` varchar(256) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `name` (`name`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `news`;</span><br><span class="line">CREATE TABLE `news` (</span><br><span class="line">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `title` varchar(128) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `link` varchar(256) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `image` varchar(256) NOT NULL DEFAULT &apos;&apos;,</span><br><span class="line">  `like_count` int NOT NULL,</span><br><span class="line">  `comment_count` int NOT NULL,</span><br><span class="line">  `created_date` datetime NOT NULL,</span><br><span class="line">  `user_id` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `loginticket`;</span><br><span class="line">CREATE TABLE `loginticket` (</span><br><span class="line">  `id` INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `user_id` INT NOT NULL,</span><br><span class="line">  `ticket` VARCHAR(45) NOT NULL,</span><br><span class="line">  `expired` DATETIME NOT NULL,</span><br><span class="line">  `status` INT NULL DEFAULT 0,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE INDEX `ticket_UNIQUE` (`ticket` ASC)</span><br><span class="line">  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `comment`;</span><br><span class="line">CREATE TABLE `comment` (</span><br><span class="line">`id` INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">`content` TEXT NOT NULL,</span><br><span class="line">`user_id` INT NOT NULL,</span><br><span class="line">`entity_id` INT NOT NULL,</span><br><span class="line">`entity_type` INT NOT NULL,</span><br><span class="line">`created_date` DATETIME NOT NULL,</span><br><span class="line">`status` INT NOT NULL DEFAULT 0,</span><br><span class="line">PRIMARY KEY (`id`),</span><br><span class="line">INDEX `entity_index` (`entity_id` ASC, `entity_type` ASC)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `message`;</span><br><span class="line">CREATE TABLE `message` (</span><br><span class="line">  `id` INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `from_id` INT NULL,</span><br><span class="line">  `to_id` INT NULL,</span><br><span class="line">  `content` TEXT NULL,</span><br><span class="line">  `created_date` DATETIME NULL,</span><br><span class="line">  `has_read` INT NULL,</span><br><span class="line">  `conversation_id` VARCHAR(45) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  INDEX `conversation_index` (`conversation_id` ASC),</span><br><span class="line">  INDEX `created_date` (`created_date` ASC))</span><br><span class="line">ENGINE = InnoDB</span><br><span class="line">DEFAULT CHARACTER SET = utf8;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">insert  user(name,password,salt,head_url) values(&apos;user1&apos;,&apos;111111&apos;,&apos;&apos;,&apos;http://images.nowcoder.com/head/111t.png&apos;);</span><br><span class="line">insert  user(name,password,salt,head_url) values(&apos;user2&apos;,&apos;222222&apos;,&apos;&apos;,&apos;http://images.nowcoder.com/head/222t.png&apos;);</span><br><span class="line">insert  user(name,password,salt,head_url) values(&apos;user3&apos;,&apos;333333&apos;,&apos;&apos;,&apos;http://images.nowcoder.com/head/333t.png&apos;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert  news(title, link, image, like_count, comment_count, created_date, user_id) values(&apos;TITLE1&apos;,&apos;http://www.nowcoder.com/1.html&apos;,&apos;http://images.nowcoder.com/head/1m.png&apos;,2,1,20180802,1);</span><br><span class="line">insert  news(title, link, image, like_count, comment_count, created_date, user_id) values(&apos;TITLE2&apos;,&apos;http://www.nowcoder.com/2.html&apos;,&apos;http://images.nowcoder.com/head/1m.png&apos;,3,2,20180802,2);</span><br><span class="line">insert  news(title, link, image, like_count, comment_count, created_date, user_id) values(&apos;TITLE3&apos;,&apos;http://www.nowcoder.com/3.html&apos;,&apos;http://images.nowcoder.com/head/1m.png&apos;,1,1,20180802,3);</span><br><span class="line"></span><br><span class="line">insert  loginticket(user_id, expired, status, ticket) values(1,20180802,0,&quot;TICKET1&quot;);</span><br><span class="line">insert  loginticket(user_id, expired, status, ticket) values(2,20180802,0,&quot;TICKET2&quot;);</span><br><span class="line">insert  loginticket(user_id, expired, status, ticket) values(3,20180802,0,&quot;TICKET3&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert  comment(user_id, content, created_date, entity_id, entity_type, status) values(1,&quot;Comment 1~~~&quot;,20180802,1,1,0);</span><br><span class="line">insert  comment(user_id, content, created_date, entity_id, entity_type, status) values(2,&quot;Comment 2~~~&quot;,20180802,2,1,0);</span><br><span class="line">insert  comment(user_id, content, created_date, entity_id, entity_type, status) values(3,&quot;Comment 3~~~&quot;,20180802,3,1,0);</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/SpringMVC/" rel="tag"><i class="fa fa-tag"></i> SpringMVC</a>
          
            <a href="/tags/Spring/" rel="tag"><i class="fa fa-tag"></i> Spring</a>
          
            <a href="/tags/Spring-boot/" rel="tag"><i class="fa fa-tag"></i> Spring boot</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/30/SpringMVC工作原理及组件/" rel="next" title="SpringMVC工作原理及组件">
                <i class="fa fa-chevron-left"></i> SpringMVC工作原理及组件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/01/JVM四.类加载机制/" rel="prev" title="JVM四.类加载机制">
                JVM四.类加载机制 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="杨旭东" />
            
              <p class="site-author-name" itemprop="name">杨旭东</p>
              <p class="site-description motion-element" itemprop="description">种一棵树最好的时间是十年前，其次是现在</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">69</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/stoneyang94" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/f7b90f4a10ae" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-book"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#单节内容"><span class="nav-number">1.</span> <span class="nav-text">单节内容</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#源码分析"><span class="nav-number">2.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-aspect"><span class="nav-number">3.</span> <span class="nav-text">1. aspect</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-LogAspect"><span class="nav-number">3.1.</span> <span class="nav-text">1.1 LogAspect</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Component"><span class="nav-number">3.1.1.</span> <span class="nav-text">1) @Component</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Logger-LOG-LoggerFactory-getLogger"><span class="nav-number">3.1.2.</span> <span class="nav-text">2) Logger LOG = LoggerFactory.getLogger()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-JoinPoint-对象"><span class="nav-number">3.1.3.</span> <span class="nav-text">3) JoinPoint 对象</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-async"><span class="nav-number">4.</span> <span class="nav-text">2. async</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异步点赞"><span class="nav-number">4.0.1.</span> <span class="nav-text">异步点赞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么异步"><span class="nav-number">4.0.1.1.</span> <span class="nav-text">为什么异步</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-LikeHandler"><span class="nav-number">4.2.</span> <span class="nav-text">2.1 LikeHandler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-参考-Spring-Autowired注解与自动装"><span class="nav-number">4.2.1.</span> <span class="nav-text">1)参考 Spring@Autowired注解与自动装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-LoginExceptionHandler"><span class="nav-number">4.3.</span> <span class="nav-text">2.2 LoginExceptionHandler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-EventConsumer"><span class="nav-number">4.4.</span> <span class="nav-text">2.3 EventConsumer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#解决的问题"><span class="nav-number">4.4.1.</span> <span class="nav-text">解决的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤"><span class="nav-number">4.4.2.</span> <span class="nav-text">步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些注释"><span class="nav-number">4.4.3.</span> <span class="nav-text">一些注释</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-EventHandler"><span class="nav-number">4.5.</span> <span class="nav-text">2.4 EventHandler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-EventModel"><span class="nav-number">4.6.</span> <span class="nav-text">2.5 EventModel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-EventProducer"><span class="nav-number">4.7.</span> <span class="nav-text">2.6 EventProducer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-JSON"><span class="nav-number">4.7.1.</span> <span class="nav-text">1) JSON</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概览"><span class="nav-number">4.7.1.1.</span> <span class="nav-text">概览</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#为什么使用-JSON？"><span class="nav-number">4.7.1.2.</span> <span class="nav-text">为什么使用 JSON？</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#使用-XML"><span class="nav-number">4.7.1.2.1.</span> <span class="nav-text">使用 XML</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用-JSON"><span class="nav-number">4.7.1.2.2.</span> <span class="nav-text">使用 JSON</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#书写格式"><span class="nav-number">4.7.1.3.</span> <span class="nav-text">书写格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#json嵌套"><span class="nav-number">4.7.1.4.</span> <span class="nav-text">json嵌套</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-前后台的传输"><span class="nav-number">4.7.2.</span> <span class="nav-text">2)前后台的传输</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-EventType"><span class="nav-number">4.8.</span> <span class="nav-text">2.7 EventType</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-configuration"><span class="nav-number">5.</span> <span class="nav-text">3. configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-ToutiaoWebConfiguration"><span class="nav-number">5.1.</span> <span class="nav-text">3.1. ToutiaoWebConfiguration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-spring-boot中使用拦截器"><span class="nav-number">5.1.1.</span> <span class="nav-text">1)spring boot中使用拦截器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1、注册拦截器"><span class="nav-number">5.1.1.1.</span> <span class="nav-text">1、注册拦截器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2、自定义拦截器"><span class="nav-number">5.1.1.2.</span> <span class="nav-text">2、自定义拦截器</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-controller"><span class="nav-number">6.</span> <span class="nav-text">4. controller</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-HomeController"><span class="nav-number">6.1.</span> <span class="nav-text">4.1. HomeController</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-IndexController"><span class="nav-number">6.2.</span> <span class="nav-text">4.2. IndexController</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-model-addAttribute-quot-k-quot-v"><span class="nav-number">6.2.1.</span> <span class="nav-text">1)model.addAttribute(&quot;k&quot;,v)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-CookieValue"><span class="nav-number">6.2.2.</span> <span class="nav-text">2)@CookieValue</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CookieValue的作用"><span class="nav-number">6.2.2.1.</span> <span class="nav-text">@CookieValue的作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CookieValue参数"><span class="nav-number">6.2.2.2.</span> <span class="nav-text">@CookieValue参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-用-JSP-设置-Cookies"><span class="nav-number">6.2.3.</span> <span class="nav-text">3)用 JSP 设置 Cookies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-request和response方法的总结"><span class="nav-number">6.2.4.</span> <span class="nav-text">4)request和response方法的总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Request"><span class="nav-number">6.2.4.1.</span> <span class="nav-text">Request</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#response"><span class="nav-number">6.2.4.2.</span> <span class="nav-text">response</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-HttpServletResponse和HttpServletRequest"><span class="nav-number">6.2.5.</span> <span class="nav-text">5)HttpServletResponse和HttpServletRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Request-1"><span class="nav-number">6.2.5.1.</span> <span class="nav-text">Request</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response"><span class="nav-number">6.2.5.2.</span> <span class="nav-text">Response</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-numeration接口"><span class="nav-number">6.2.6.</span> <span class="nav-text">6)numeration接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-Iterator接口"><span class="nav-number">6.2.7.</span> <span class="nav-text">7)Iterator接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-Spring-MVC-重定向常用处理方式"><span class="nav-number">6.2.8.</span> <span class="nav-text">8) Spring MVC 重定向常用处理方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#String-重定向"><span class="nav-number">6.2.9.</span> <span class="nav-text">String 重定向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ModelAndView-重定向"><span class="nav-number">6.2.10.</span> <span class="nav-text">ModelAndView 重定向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RedirectView-重定向"><span class="nav-number">6.2.11.</span> <span class="nav-text">RedirectView 重定向</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-LikeController"><span class="nav-number">6.3.</span> <span class="nav-text">4.3. LikeController</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-LoginController"><span class="nav-number">6.4.</span> <span class="nav-text">4.4. LoginController</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-MessageController"><span class="nav-number">6.5.</span> <span class="nav-text">4.5 MessageController</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-NewsController"><span class="nav-number">6.6.</span> <span class="nav-text">4.6 NewsController</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-7-SettingController"><span class="nav-number">6.7.</span> <span class="nav-text">4.7. SettingController</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-RequestBody"><span class="nav-number">6.7.1.</span> <span class="nav-text">1)@RequestBody</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-ResponseBody"><span class="nav-number">6.7.2.</span> <span class="nav-text">2)@ResponseBody</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-DAO"><span class="nav-number">7.</span> <span class="nav-text">5. DAO</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-CommentDAO"><span class="nav-number">7.1.</span> <span class="nav-text">5.1 CommentDAO</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-DAO在JavaWeb开发中的定位"><span class="nav-number">7.1.1.</span> <span class="nav-text">1)DAO在JavaWeb开发中的定位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Mapper注解"><span class="nav-number">7.1.2.</span> <span class="nav-text">2)@Mapper注解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用：持久化"><span class="nav-number">7.1.2.1.</span> <span class="nav-text">作用：持久化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-LoginTicketDAO"><span class="nav-number">7.2.</span> <span class="nav-text">5.2 LoginTicketDAO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-MessageDAO"><span class="nav-number">7.3.</span> <span class="nav-text">5.3 MessageDAO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-NewsDAO"><span class="nav-number">7.4.</span> <span class="nav-text">5.4 NewsDAO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-UserDAO"><span class="nav-number">7.5.</span> <span class="nav-text">5.5 UserDAO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-interceptor"><span class="nav-number">8.</span> <span class="nav-text">6. interceptor</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-LoginRequiredInterceptor"><span class="nav-number">8.1.</span> <span class="nav-text">6.1 LoginRequiredInterceptor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-拦截器-Interceptor"><span class="nav-number">8.1.1.</span> <span class="nav-text">1)拦截器(Interceptor)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用"><span class="nav-number">8.1.1.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分类"><span class="nav-number">8.1.1.2.</span> <span class="nav-text">分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringMVC处理请求过程"><span class="nav-number">8.1.1.3.</span> <span class="nav-text">SpringMVC处理请求过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#需要Override的三种方法"><span class="nav-number">8.1.1.4.</span> <span class="nav-text">需要Override的三种方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在Spring-Boot中配置拦截器，需要写一个配置类继承WebMvcConfigurerAdapter类并添加该拦截器-见2"><span class="nav-number">8.1.1.5.</span> <span class="nav-text">在Spring Boot中配置拦截器，需要写一个配置类继承WebMvcConfigurerAdapter类并添加该拦截器(见2)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-PassportInterceptor"><span class="nav-number">8.2.</span> <span class="nav-text">6.2 PassportInterceptor</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-model"><span class="nav-number">9.</span> <span class="nav-text">7. model</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-Comment"><span class="nav-number">9.1.</span> <span class="nav-text">7.1 Comment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-EntityType"><span class="nav-number">9.2.</span> <span class="nav-text">7.2 EntityType</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-HostHolder"><span class="nav-number">9.3.</span> <span class="nav-text">7.3 HostHolder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-LoginTicket"><span class="nav-number">9.4.</span> <span class="nav-text">7.4 LoginTicket</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-5-Message"><span class="nav-number">9.5.</span> <span class="nav-text">7.5 Message</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-6-News"><span class="nav-number">9.6.</span> <span class="nav-text">7.6 News</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-7-User"><span class="nav-number">9.7.</span> <span class="nav-text">7.7 User</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-8-ViewObject"><span class="nav-number">9.8.</span> <span class="nav-text">7.8 ViewObject</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-service"><span class="nav-number">10.</span> <span class="nav-text">8. service</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-CommentService"><span class="nav-number">10.1.</span> <span class="nav-text">8.1 CommentService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-LikeService"><span class="nav-number">10.2.</span> <span class="nav-text">8.2 LikeService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-MessageService"><span class="nav-number">10.3.</span> <span class="nav-text">8.3 MessageService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4-NewsService"><span class="nav-number">10.4.</span> <span class="nav-text">8.4 NewsService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-5-QiniuService"><span class="nav-number">10.5.</span> <span class="nav-text">8.5 QiniuService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-6-ToutiaoService"><span class="nav-number">10.6.</span> <span class="nav-text">8.6 ToutiaoService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-7-UserService"><span class="nav-number">10.7.</span> <span class="nav-text">8.7 UserService</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-util"><span class="nav-number">11.</span> <span class="nav-text">9. util</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-JedisAdapter"><span class="nav-number">11.1.</span> <span class="nav-text">9.1 JedisAdapter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-MailSender"><span class="nav-number">11.2.</span> <span class="nav-text">9.2 MailSender</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-RedisKeyUtil"><span class="nav-number">11.3.</span> <span class="nav-text">9.3 RedisKeyUtil</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-4-ToutiaoUtil"><span class="nav-number">11.4.</span> <span class="nav-text">9.4 ToutiaoUtil</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-ToutiaoApplication"><span class="nav-number">12.</span> <span class="nav-text">10. ToutiaoApplication</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-的SpringApplication"><span class="nav-number">12.0.1.</span> <span class="nav-text">spring 的SpringApplication</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用：入口类"><span class="nav-number">12.0.1.1.</span> <span class="nav-text">作用：入口类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Boot的SpringApplication类"><span class="nav-number">12.0.2.</span> <span class="nav-text">Spring Boot的SpringApplication类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-配置文件及模板"><span class="nav-number">13.</span> <span class="nav-text">11. 配置文件及模板</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-NewsDAO-xml"><span class="nav-number">13.1.</span> <span class="nav-text">11.1 NewsDAO.xml</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MyBatis的Mapper-XML-文件"><span class="nav-number">13.1.1.</span> <span class="nav-text">MyBatis的Mapper XML 文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL-映射顶级元素（按照它们应该被定义的顺序）"><span class="nav-number">13.1.1.1.</span> <span class="nav-text">SQL 映射顶级元素（按照它们应该被定义的顺序）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#属性"><span class="nav-number">13.1.1.2.</span> <span class="nav-text">属性</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2-application-properties"><span class="nav-number">13.2.</span> <span class="nav-text">11.2 application.properties</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-mybatis-config-xml"><span class="nav-number">13.3.</span> <span class="nav-text">11.3  mybatis-config.xml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-4-toolbox-xml"><span class="nav-number">13.4.</span> <span class="nav-text">11.4 toolbox.xml</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12-test"><span class="nav-number">14.</span> <span class="nav-text">12. test</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#12-1-InitDatabaseTests"><span class="nav-number">14.1.</span> <span class="nav-text">12.1 InitDatabaseTests</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-SpringBoot-Web项目中中如何使用Junit"><span class="nav-number">14.1.1.</span> <span class="nav-text">1)SpringBoot Web项目中中如何使用Junit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-随机数—random-nextInt-1000"><span class="nav-number">14.1.2.</span> <span class="nav-text">2)随机数—random.nextInt(1000)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-2-JedisTests"><span class="nav-number">14.2.</span> <span class="nav-text">12.2 JedisTests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-3-LikeServiceTests"><span class="nav-number">14.3.</span> <span class="nav-text">12.3  LikeServiceTests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-4-测试多线程"><span class="nav-number">14.4.</span> <span class="nav-text">12.4 测试多线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-5-ToutiaoApplicationTests"><span class="nav-number">14.5.</span> <span class="nav-text">12.5 ToutiaoApplicationTests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-6-init-schama-sql"><span class="nav-number">14.6.</span> <span class="nav-text">12.6  init-schama.sql</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨旭东</span>

  
</div>

<!-- 20180426 -->
<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>


<!-- 20180425

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>

-->

<!-- 20180425

  <span class="post-meta-divider">|</span>

-->

<!-- 20180425

  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>

-->



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  <!--页面点击小红心 -->
  <script type="text/javascript" src="/js/src/love.js"></script>>
    <!--背景动画 -->
  <script type="text/javascript" src="/js/src/background.js"></script>>
</body>
</html>
